<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Sheet Data Manager</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Very light blue background */
        }
        .scroll-container::-webkit-scrollbar {
            height: 8px;
        }
        .scroll-container::-webkit-scrollbar-thumb {
            background-color: #94a3b8; /* slate-400 */
            border-radius: 4px;
        }
        .scroll-container::-webkit-scrollbar-track {
            background-color: #e2e8f0; /* slate-200 */
        }
        /* Custom styling for the Upcoming Matches Scroller */
        .match-scroller {
            display: flex;
            overflow-x: auto;
            gap: 1rem;
            padding: 1rem 0;
            white-space: nowrap; /* Prevent items from wrapping */
            scroll-behavior: smooth;
        }
        .match-scroller::-webkit-scrollbar {
            display: none; /* Hide scrollbar for cleaner look */
        }
        .match-card {
            flex: 0 0 auto; /* Prevent cards from growing or shrinking */
            width: 280px;
            min-width: 280px;
            background: linear-gradient(135deg, #1f2937, #374151); /* Dark gradient background */
            color: white;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
        }
        .match-card:hover {
            transform: translateY(-4px);
        }

        /* Styling for the modal backdrop */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            backdrop-filter: blur(4px);
        }
        .modal-content {
            max-height: 90vh; /* Limit height for responsiveness */
            overflow-y: auto;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">

        <!-- Header and Title - DataCompass 360 -->
        <header class="mb-8 p-6 bg-white shadow-2xl rounded-2xl border-t-4 border-blue-500">
            <div class="flex items-center space-x-4">
                <!-- Icon/Feature: Compass/Data Point SVG -->
                <div class="p-3 bg-blue-100 rounded-xl shadow-md">
                    <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <!-- Compass structure -->
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm0 18a8 8 0 110-16 8 8 0 010 16zm-1-10.5h2V14h-2zm0-4h2V8h-2z"/>
                        <!-- North arrow -->
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0zM12 18V6"/>
                    </svg>
                </div>
                <!-- Title Text -->
                <div>
                    <h1 class="text-4xl font-extrabold text-gray-900 mb-1">
                        DataCompass 360
                    </h1>
                    <p class="text-gray-600 font-medium">
                        Real-Time Football Insights | Click rows for **Team Stats**
                    </p>
                </div>
            </div>
        </header>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="mb-6 p-4 bg-blue-50 border border-blue-200 text-sm font-medium text-blue-800 rounded-lg flex items-center justify-center hidden">
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-500 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Loading Data...
        </div>

        <!-- Dynamic Filters and Search Panel -->
        <div class="mb-6 p-6 bg-white shadow-xl rounded-2xl">
            <h2 class="text-xl font-bold text-gray-700 mb-4">Filter Controls</h2>
            
            <!-- Team Search -->
            <div class="mb-6">
                 <label for="team-search-input" class="block text-sm font-medium text-gray-700 mb-1">Team Search (by Match)</label>
                 <input type="text" id="team-search-input" placeholder="Search for teams (e.g., Chelsea vs. Arsenal)..."
                       class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-4 focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                       oninput="handleTeamSearch()">
            </div>


            <!-- Dropdown Filters: League, Prediction, Date -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div>
                    <label for="filter-league" class="block text-sm font-medium text-gray-700 mb-1">League</label>
                    <select id="filter-league" onchange="handleFilterChange()" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <!-- Options populated dynamically -->
                    </select>
                </div>
                <div>
                    <label for="filter-prediction" class="block text-sm font-medium text-gray-700 mb-1">Prediction</label>
                    <select id="filter-prediction" onchange="handleFilterChange()" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <!-- Options populated dynamically -->
                    </select>
                </div>
                <div>
                    <label for="filter-matchDate" class="block text-sm font-medium text-gray-700 mb-1">Match Date</label>
                    <select id="filter-matchDate" onchange="handleFilterChange()" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <!-- Options populated dynamically -->
                    </select>
                </div>
            </div>

            <!-- Range Filters: Stakes and Streaks -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Stake Range -->
                <div class="p-3 border border-gray-200 rounded-lg bg-gray-50">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Stake Range</label>
                    <div class="flex space-x-2">
                        <input type="number" id="filter-stake-min" placeholder="Min Stake" oninput="handleFilterChange()"
                               class="w-1/2 p-2 border border-gray-300 rounded-lg text-sm">
                        <input type="number" id="filter-stake-max" placeholder="Max Stake" oninput="handleFilterChange()"
                               class="w-1/2 p-2 border border-gray-300 rounded-lg text-sm">
                    </div>
                </div>

                <!-- Winning Streak Range -->
                <div class="p-3 border border-gray-200 rounded-lg bg-gray-50">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Winning Streak Range</label>
                    <div class="flex space-x-2">
                        <input type="number" id="filter-wstreak-min" placeholder="Min Streak" oninput="handleFilterChange()"
                               class="w-1/2 p-2 border border-gray-300 rounded-lg text-sm">
                        <input type="number" id="filter-wstreak-max" placeholder="Max Streak" oninput="handleFilterChange()"
                               class="w-1/2 p-2 border border-gray-300 rounded-lg text-sm">
                    </div>
                </div>
                
                <!-- Losing Streak Range -->
                <div class="p-3 border border-gray-200 rounded-lg bg-gray-50">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Losing Streak Range</label>
                    <div class="flex space-x-2">
                        <input type="number" id="filter-lstreak-min" placeholder="Min Streak" oninput="handleFilterChange()"
                               class="w-1/2 p-2 border border-gray-300 rounded-lg text-sm">
                        <input type="number" id="filter-lstreak-max" placeholder="Max Streak" oninput="handleFilterChange()"
                               class="w-1/2 p-2 border border-gray-300 rounded-lg text-sm">
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Table Container -->
        <div class="bg-white shadow-2xl rounded-2xl overflow-hidden ring-1 ring-gray-200 mb-8">
            <!-- Table Wrapper with horizontal scroll on small screens -->
            <div class="overflow-x-auto scroll-container">
                <table id="data-table" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100 sticky top-0 z-10 border-b-2 border-gray-300">
                        <tr>
                            <!-- Table headers will be injected here -->
                        </tr>
                    </thead>
                    <tbody id="table-body" class="bg-white divide-y divide-gray-100">
                        <!-- Table rows will be injected here -->
                    </tbody>
                </table>
            </div>

            <!-- Error/Empty State Message Box -->
            <div id="message-box" class="p-8 text-center hidden">
                <p class="text-lg font-semibold text-gray-600">No data available or error during fetch.</p>
                <p class="text-sm text-gray-400">Please check the console for details.</p>
            </div>
        </div>

        <!-- Pagination Controls -->
        <div id="pagination-controls" class="mt-4 p-4 bg-white shadow-xl rounded-2xl flex justify-between items-center hidden">
            <button id="prev-button" onclick="handlePrevPage()"
                    class="px-4 py-2 text-sm font-medium rounded-full text-blue-700 bg-blue-100 hover:bg-blue-200 disabled:opacity-50 transition duration-150 shadow-md">
                <span class="inline-flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    Previous
                </span>
            </button>
            <span id="page-status" class="text-sm font-medium text-gray-600"></span>
            <button id="next-button" onclick="handleNextPage()"
                    class="px-4 py-2 text-sm font-medium rounded-full text-blue-700 bg-blue-100 hover:bg-blue-200 disabled:opacity-50 transition duration-150 shadow-md">
                 <span class="inline-flex items-center">
                    Next
                    <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                 </span>
            </button>
        </div>
        
        <!-- Upcoming Matches Scroller (New Feature) -->
        <div class="mt-8 p-6 bg-gray-800 rounded-2xl shadow-2xl">
            <h2 class="text-2xl font-bold text-yellow-400 mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                Upcoming Matches (Next 30 Mins)
            </h2>
            <div id="upcoming-matches-scroller" class="match-scroller">
                <!-- Match cards will be injected here -->
            </div>
        </div>

    </div>

    <!-- Details Modal (Hidden by default) -->
    <div id="details-modal" class="modal-backdrop hidden" onclick="hideModal(event)">
        <div class="modal-content w-full max-w-4xl mx-4 bg-white rounded-3xl shadow-2xl transform transition-all duration-300" 
             onclick="event.stopPropagation()">
            
            <div class="p-6 md:p-8">
                <!-- Modal Header -->
                <div class="flex justify-between items-start mb-6 border-b pb-4">
                    <h3 id="modal-match-title" class="text-2xl md:text-3xl font-extrabold text-gray-800">Match Details</h3>
                    <button onclick="hideModal()" class="text-gray-400 hover:text-gray-600 transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>

                <!-- Modal Content -->
                <div id="modal-content-stats" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Statistics will be dynamically injected here -->
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        // --- Configuration ---
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTqrL4iqD-lA0bQlJ_9zt0WaExOONsizhGyigkGsgHAGwCexf2b5p548fqUvCmET5GFAPSf6Ef74y7X/pub?gid=0&single=true&output=csv';

        // Columns required for the main table and the modal
        const COLUMN_MAP = [
            // Visible Table Columns
            { key: 'Match Date', label: 'Date', sortable: true, type: 'string' },
            { key: 'League', label: 'League', sortable: true, type: 'string' },
            { key: 'Match', label: 'Match', sortable: true, type: 'string' },
            { key: 'Home Odds', label: 'Home Odds', sortable: true, type: 'number' },
            { key: 'Draw Odds', label: 'Draw Odds', sortable: true, type: 'number' },
            { key: 'Away Odds', label: 'Away Odds', sortable: true, type: 'number' },
            { key: 'Correct Score', label: 'Score', sortable: true, type: 'string' },
            { key: 'Prediction', label: 'Prediction', sortable: true, type: 'string' },
            { key: 'Winning Streak', label: 'W Streak', sortable: true, type: 'number' },
            { key: 'Losing Streak', label: 'L Streak', sortable: true, type: 'number' },
            { key: 'Stake', label: 'Stake', sortable: true, type: 'number' },
            { key: 'Result', label: 'Result', sortable: true, type: 'string' },
            { key: 'Outcome', label: 'Outcome', sortable: true, type: 'string' },
            
            // Hidden Modal Columns (Must be parsed)
            { key: 'Home Team', label: 'Home Team', sortable: false, type: 'string' },
            { key: 'Away Team', label: 'Away Team', sortable: false, type: 'string' },
            { key: 'Home Wins', label: 'Home Wins', sortable: false, type: 'number' },
            { key: 'Home Losses', label: 'Home Losses', sortable: false, type: 'number' },
            { key: 'Away Wins', label: 'Away Wins', sortable: false, type: 'number' },
            { key: 'Away Draws', label: 'Away Draws', sortable: false, type: 'number' },
            { key: 'Away Losses', label: 'Away Losses', sortable: false, type: 'number' },
            { key: 'Home Team Scored', label: 'Home Team Scored', sortable: false, type: 'number' },
            { key: 'Home Avg Scored', label: 'Home Avg Scored', sortable: false, type: 'number' },
            { key: 'Home Conceded', label: 'Home Conceded', sortable: false, type: 'number' },
            { key: 'Home Avg Conceded', label: 'Home Avg Conceded', sortable: false, type: 'number' },
            { key: 'Away Team Scored', label: 'Away Team Scored', sortable: false, type: 'number' },
            { key: 'Away Avg Scored', label: 'Away Avg Scored', sortable: false, type: 'number' },
            { key: 'Away Conceded', label: 'Away Conceded', sortable: false, type: 'number' },
            { key: 'Away Avg Conceded', label: 'Away Avg Conceded', sortable: false, type: 'number' }
        ];

        // --- State Management ---
        let allData = [];      // Stores the original parsed data
        let currentData = [];  // Stores data after filtering/sorting (full set)
        let sortColumn = 'Match Date';
        let sortDirection = 'desc'; 
        let rowsPerPage = 30;
        let currentPage = 1;

        let filters = {
            league: 'All',
            prediction: 'All',
            matchDate: 'All',
            winningStreakMin: null,
            winningStreakMax: null,
            losingStreakMin: null,
            losingStreakMax: null,
            stakeMin: null,
            stakeMax: null,
            teamSearch: '',
        };

        // --- DOM Elements ---
        const tableBody = document.getElementById('table-body');
        const tableHeadRow = document.querySelector('#data-table thead tr');
        const loadingIndicator = document.getElementById('loading-indicator');
        const messageBox = document.getElementById('message-box');
        const paginationControls = document.getElementById('pagination-controls');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const pageStatus = document.getElementById('page-status');
        const detailsModal = document.getElementById('details-modal');
        const modalMatchTitle = document.getElementById('modal-match-title');
        const modalContentStats = document.getElementById('modal-content-stats');
        const upcomingScroller = document.getElementById('upcoming-matches-scroller');

        // --- Utility Functions (CSV Parsing, Filtering, Sorting) ---

        /**
         * Simple CSV parser that assumes the first row is headers. (Kept from previous version)
         */
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length === 0) return [];

            const rawHeaders = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const dataRows = lines.slice(1);
            const parsedData = [];

            const headerIndexMap = COLUMN_MAP.reduce((acc, col, requestedIndex) => {
                const csvIndex = rawHeaders.indexOf(col.key);
                if (csvIndex !== -1) {
                    acc[requestedIndex] = csvIndex;
                } else {
                    const csvIndexByLabel = rawHeaders.indexOf(col.label);
                    if (csvIndexByLabel !== -1) {
                         acc[requestedIndex] = csvIndexByLabel;
                    } else {
                        acc[requestedIndex] = requestedIndex;
                    }
                }
                return acc;
            }, {});


            dataRows.forEach(line => {
                if (!line.trim()) return;
                const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.trim().replace(/"/g, ''));
                
                const rowObject = {};
                COLUMN_MAP.forEach((col, requestedIndex) => {
                    const csvIndex = headerIndexMap[requestedIndex];
                    if (csvIndex !== undefined && values[csvIndex] !== undefined) {
                        let value = values[csvIndex];
                        if (col.type === 'number') {
                            rowObject[col.key] = isNaN(parseFloat(value)) ? null : parseFloat(value);
                        } else {
                            rowObject[col.key] = value;
                        }
                    } else {
                        rowObject[col.key] = ''; 
                    }
                });
                parsedData.push(rowObject);
            });

            return parsedData.filter(row => Object.values(row).some(v => v !== '' && v !== null));
        }

        function initializeFilters() {
            const getUniqueValues = (key) => {
                const values = allData.map(item => item[key]).filter(Boolean).map(String);
                return ['All', ...new Set(values)].sort();
            };

            const populateDropdown = (id, values) => {
                const select = document.getElementById(id);
                if (!select) return;

                select.innerHTML = '';
                values.forEach(value => {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = value;
                    select.appendChild(option);
                });
            };

            populateDropdown('filter-league', getUniqueValues('League'));
            populateDropdown('filter-prediction', getUniqueValues('Prediction'));
            populateDropdown('filter-matchDate', getUniqueValues('Match Date'));
            
            document.getElementById('filter-stake-min').value = '';
            document.getElementById('filter-stake-max').value = '';
            document.getElementById('filter-wstreak-min').value = '';
            document.getElementById('filter-wstreak-max').value = '';
            document.getElementById('filter-lstreak-min').value = '';
            document.getElementById('filter-lstreak-max').value = '';
            document.getElementById('team-search-input').value = '';
        }

        function renderTableHead() {
            const visibleColumns = COLUMN_MAP.filter(col => !['Home Team', 'Away Team', 'Home Wins', 'Home Losses', 'Away Wins', 'Away Draws', 'Away Losses', 'Home Team Scored', 'Home Avg Scored', 'Home Conceded', 'Home Avg Conceded', 'Away Team Scored', 'Away Avg Scored', 'Away Conceded', 'Away Avg Conceded'].includes(col.key));

            tableHeadRow.innerHTML = visibleColumns.map(col => {
                let icon = '';
                if (col.key === sortColumn) {
                    icon = sortDirection === 'asc' 
                        ? '<svg class="w-4 h-4 ml-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>'
                        : '<svg class="w-4 h-4 ml-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>';
                }
                
                return `
                    <th onclick="handleSort('${col.key}')" 
                        class="px-4 py-3 text-left text-xs font-extrabold text-gray-700 uppercase tracking-wider cursor-pointer hover:bg-gray-200 transition duration-150 whitespace-nowrap">
                        <div class="flex items-center">
                            ${col.label}
                            ${icon}
                        </div>
                    </th>
                `;
            }).join('');
        }
        
        // --- Enhanced Rendering for Rows ---
        function renderTableBody(dataSlice) {
            tableBody.innerHTML = '';
            
            if (currentData.length === 0) {
                messageBox.classList.remove('hidden');
                messageBox.querySelector('p:first-child').textContent = 'No results found matching your criteria.';
                return;
            } else {
                messageBox.classList.add('hidden');
            }

            const startIndex = (currentPage - 1) * rowsPerPage;

            const visibleColumnKeys = COLUMN_MAP
                .filter(col => !['Home Team', 'Away Team', 'Home Wins', 'Home Losses', 'Away Wins', 'Away Draws', 'Away Losses', 'Home Team Scored', 'Home Avg Scored', 'Home Conceded', 'Home Avg Conceded', 'Away Team Scored', 'Away Avg Scored', 'Away Conceded', 'Away Avg Conceded'].includes(col.key))
                .map(col => col.key);


            dataSlice.forEach((item, sliceIndex) => {
                const row = document.createElement('tr');
                // Added enhanced row styling: alternating background and strong hover effect
                const rowClass = sliceIndex % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                row.classList.add(rowClass, 'hover:bg-blue-100', 'transition', 'duration-150', 'cursor-pointer', 'border-b', 'border-gray-200');
                
                const dataIndex = startIndex + sliceIndex;
                row.onclick = () => showDetailsModal(dataIndex);


                visibleColumnKeys.forEach(key => {
                    const col = COLUMN_MAP.find(c => c.key === key);
                    const cell = document.createElement('td');
                    let content = (item[col.key] !== null && item[col.key] !== undefined) ? item[col.key].toString() : '';
                    cell.classList.add('px-4', 'py-3', 'whitespace-nowrap', 'text-sm');
                    
                    // Apply conditional styling for 'Outcome', 'Result', and numbers
                    if (col.key === 'Outcome') {
                        const isWin = content.toLowerCase() === 'win';
                        const bgColor = isWin ? 'bg-green-600' : 'bg-red-600';
                        const textColor = 'text-white';
                        cell.innerHTML = `<span class="px-3 py-1 inline-flex text-xs leading-5 font-bold rounded-full ${bgColor} ${textColor} shadow-md">${content || 'N/A'}</span>`;
                        cell.classList.add('text-center');
                    } 
                    else if (col.key === 'Result') {
                        const lowerContent = content.toLowerCase();
                        const isHit = lowerContent.includes('hit');
                        const isMiss = lowerContent.includes('miss');
                        const isPending = lowerContent.includes('pending');
                        let bgColor = 'bg-gray-200';
                        let textColor = 'text-gray-800';
                        if (isHit) { bgColor = 'bg-emerald-500'; textColor = 'text-white'; }
                        if (isMiss) { bgColor = 'bg-rose-500'; textColor = 'text-white'; }
                        if (isPending) { bgColor = 'bg-amber-500'; textColor = 'text-white'; }

                        cell.innerHTML = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${bgColor} ${textColor}">${content || 'N/A'}</span>`;
                    }
                    else if (col.type === 'number') {
                        cell.classList.add('text-right', 'font-mono', 'text-gray-700', 'font-semibold');
                        if (col.key.includes('Odds') || col.key === 'Stake') {
                            cell.textContent = item[col.key] !== null ? item[col.key].toFixed(2) : 'N/A';
                        } else {
                            cell.textContent = content; 
                        }
                    }
                    else {
                         cell.classList.add('text-gray-900');
                         cell.textContent = content;
                    }

                    row.appendChild(cell);
                });
                tableBody.appendChild(row);
            });
        }
        
        function renderStatBlock(title, value, iconSvg, colorClass) {
            return `
                <div class="flex items-center space-x-4 p-4 bg-white rounded-xl shadow-lg transition duration-200 hover:shadow-xl hover:ring-2 hover:ring-${colorClass.replace('text-', '')}-500">
                    <div class="p-3 rounded-full ${colorClass.replace('text-', 'bg-')}-100">
                        <svg class="w-6 h-6 ${colorClass}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">${iconSvg}</svg>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-500 uppercase">${title}</p>
                        <p class="text-xl font-bold text-gray-900">${value}</p>
                    </div>
                </div>
            `;
        }

        window.showDetailsModal = function(dataIndex) {
            const item = currentData[dataIndex];
            if (!item) return;

            modalMatchTitle.textContent = `${item['Match']} (${item['League']})`;
            
            const formatNumber = (key, decimals = 2) => {
                const value = item[key];
                return value !== null && value !== undefined ? value.toFixed(decimals) : 'N/A';
            };

            const formatInteger = (key) => {
                 const value = item[key];
                 return value !== null && value !== undefined ? Math.round(value) : 'N/A';
            };

            const homeStats = `
                <div class="p-4 rounded-xl bg-indigo-50 border-t-4 border-indigo-500 shadow-inner">
                    <h4 class="text-xl font-bold text-indigo-700 mb-4">${item['Home Team'] || 'Home Team'} (Home Stats)</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <!-- Home Wins -->
                        ${renderStatBlock('Home Wins', formatInteger('Home Wins'), '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.087 20.375l-.337.337m0 0l-7.5-7.5m7.5 7.5l7.5-7.5m-7.5 7.5l-.337.337m0 0l-7.5-7.5m7.5 7.5l7.5-7.5"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13.5l3 3 7-7"></path>', 'text-green-500')}
                        <!-- Home Losses -->
                        ${renderStatBlock('Home Losses', formatInteger('Home Losses'), '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7 5V3H3v18h18z"></path>', 'text-red-500')}
                        
                        <!-- Home Scored -->
                        ${renderStatBlock('Total Scored', formatInteger('Home Team Scored'), '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>', 'text-blue-500')}
                        <!-- Home Avg Scored -->
                        ${renderStatBlock('Avg Scored', formatNumber('Home Avg Scored'), '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6m6 0h6m-6 0v-6m6 6v-6a2 2 0 00-2-2h-2a2 2 0 00-2 2v6m0 0H9m-9 0h24"></path>', 'text-blue-500')}
                        
                        <!-- Home Conceded -->
                        ${renderStatBlock('Total Conceded', formatInteger('Home Conceded'), '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11V3m0 0L8 7m4-4l4 4m-4 8v6m0 0l4-4m-4 4l-4-4"></path>', 'text-yellow-600')}
                        <!-- Home Avg Conceded -->
                        ${renderStatBlock('Avg Conceded', formatNumber('Home Avg Conceded'), '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m-3 0h24"></path>', 'text-yellow-600')}

                    </div>
                </div>
            `;

            const awayStats = `
                <div class="p-4 rounded-xl bg-purple-50 border-t-4 border-purple-500 shadow-inner">
                    <h4 class="text-xl font-bold text-purple-700 mb-4">${item['Away Team'] || 'Away Team'} (Away Stats)</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <!-- Away Wins -->
                        ${renderStatBlock('Away Wins', formatInteger('Away Wins'), '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.087 20.375l-.337.337m0 0l-7.5-7.5m7.5 7.5l7.5-7.5m-7.5 7.5l-.337.337m0 0l-7.5-7.5m7.5 7.5l7.5-7.5"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13.5l3 3 7-7"></path>', 'text-green-500')}
                        <!-- Away Draws -->
                        ${renderStatBlock('Away Draws', formatInteger('Away Draws'), '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m-9 3v4m0 0h6m-6 0h6m0 0l-3 3m3-3l-3-3m-6 3h.01M9 16h.01"></path>', 'text-cyan-500')}
                        <!-- Away Losses -->
                        ${renderStatBlock('Away Losses', formatInteger('Away Losses'), '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7 5V3H3v18h18z"></path>', 'text-red-500')}
                        
                        <!-- Away Scored -->
                        ${renderStatBlock('Total Scored', formatInteger('Away Team Scored'), '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>', 'text-blue-500')}
                        <!-- Away Avg Scored -->
                        ${renderStatBlock('Avg Scored', formatNumber('Away Avg Scored'), '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6m6 0h6m-6 0v-6m6 6v-6a2 2 0 00-2-2h-2a2 2 0 00-2 2v6m0 0H9m-9 0h24"></path>', 'text-blue-500')}
                        
                        <!-- Away Conceded -->
                        ${renderStatBlock('Total Conceded', formatInteger('Away Conceded'), '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11V3m0 0L8 7m4-4l4 4m-4 8v6m0 0l4-4m-4 4l-4-4"></path>', 'text-yellow-600')}
                        <!-- Away Avg Conceded -->
                        ${renderStatBlock('Avg Conceded', formatNumber('Away Avg Conceded'), '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m-3 0h24"></path>', 'text-yellow-600')}

                    </div>
                </div>
            `;
            
            modalContentStats.innerHTML = homeStats + awayStats;
            detailsModal.classList.remove('hidden');
        }

        window.hideModal = function(event) {
            if (event && event.target !== detailsModal) return; 
            detailsModal.classList.add('hidden');
        }

        function updatePaginationControls() {
            const totalRows = currentData.length;
            const totalPages = Math.ceil(totalRows / rowsPerPage);

            if (totalRows <= rowsPerPage || totalRows === 0) {
                paginationControls.classList.add('hidden');
            } else {
                paginationControls.classList.remove('hidden');
            }

            prevButton.disabled = currentPage === 1;
            nextButton.disabled = currentPage >= totalPages;
            
            pageStatus.textContent = `Page ${currentPage} of ${totalPages} (${totalRows} total rows)`;
        }

        function renderTable() {
            currentData = applyFilters(allData);
            
            const totalPages = Math.ceil(currentData.length / rowsPerPage);
            if (currentPage > totalPages) {
                currentPage = Math.max(1, totalPages);
            }
            if (currentData.length > 0 && currentPage === 0) {
                 currentPage = 1;
            }

            const sortCol = COLUMN_MAP.find(col => col.key === sortColumn);
            if (sortCol) {
                currentData.sort((a, b) => {
                    let valA = a[sortColumn];
                    let valB = b[sortColumn];

                    const isANull = valA === null || valA === undefined || valA === '';
                    const isBNull = valB === null || valB === undefined || valB === '';
                    
                    if (isANull && isBNull) return 0;
                    if (isANull) return sortDirection === 'asc' ? 1 : -1;
                    if (isBNull) return sortDirection === 'asc' ? -1 : 1;

                    let comparison = 0;
                    if (sortCol.type === 'number') {
                        comparison = valA - valB;
                    } else { 
                        comparison = valA.toString().localeCompare(valB.toString());
                    }

                    return sortDirection === 'asc' ? comparison : -comparison;
                });
            }

            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = startIndex + rowsPerPage;
            const dataSlice = currentData.slice(startIndex, endIndex);

            renderTableHead();
            renderTableBody(dataSlice);
            updatePaginationControls();
        }

        function applyFilters(data) {
            let filtered = data.filter(item => {
                const search = filters.teamSearch.toLowerCase();
                if (!search) return true;
                return item['Match']?.toString().toLowerCase().includes(search);
            });

            filtered = filtered.filter(item => {
                const isLeagueMatch = filters.league === 'All' || item['League'] === filters.league;
                const isPredictionMatch = filters.prediction === 'All' || item['Prediction'] === filters.prediction;
                const isDateMatch = filters.matchDate === 'All' || item['Match Date'] === filters.matchDate;
                return isLeagueMatch && isPredictionMatch && isDateMatch;
            });

            filtered = filtered.filter(item => {
                const checkRange = (key, min, max) => {
                    if (min === null && max === null) return true;
                    const value = item[key];
                    if (value === null && (min !== null || max !== null)) return false;

                    const minPass = min === null || value >= min;
                    const maxPass = max === null || value <= max;
                    return minPass && maxPass;
                };

                const isStakeMatch = checkRange('Stake', filters.stakeMin, filters.stakeMax);
                const isWStreakMatch = checkRange('Winning Streak', filters.winningStreakMin, filters.winningStreakMax);
                const isLStreakMatch = checkRange('Losing Streak', filters.losingStreakMin, filters.losingStreakMax);

                return isStakeMatch && isWStreakMatch && isLStreakMatch;
            });

            return filtered;
        }

        // --- Event Handlers (kept from previous version) ---
        window.handleFilterChange = function() {
            filters.league = document.getElementById('filter-league').value;
            filters.prediction = document.getElementById('filter-prediction').value;
            filters.matchDate = document.getElementById('filter-matchDate').value;
            filters.stakeMin = parseFloat(document.getElementById('filter-stake-min').value) || null;
            filters.stakeMax = parseFloat(document.getElementById('filter-stake-max').value) || null;
            filters.winningStreakMin = parseInt(document.getElementById('filter-wstreak-min').value) || null;
            filters.winningStreakMax = parseInt(document.getElementById('filter-wstreak-max').value) || null;
            filters.losingStreakMin = parseInt(document.getElementById('filter-lstreak-min').value) || null;
            filters.losingStreakMax = parseInt(document.getElementById('filter-lstreak-max').value) || null;

            currentPage = 1; 
            renderTable();
        }

        window.handleTeamSearch = function() {
            filters.teamSearch = document.getElementById('team-search-input').value;
            currentPage = 1; 
            renderTable();
        }

        window.handleSort = function(columnKey) {
            if (sortColumn === columnKey) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = columnKey;
                sortDirection = 'asc';
            }
            currentPage = 1; 
            renderTable();
        }

        window.handleNextPage = function() {
            const totalPages = Math.ceil(currentData.length / rowsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderTable();
            }
        }

        window.handlePrevPage = function() {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
        }
        
        // --- New Feature: Upcoming Matches Scroller Logic ---
        const leagues = ['Premier League', 'La Liga', 'Serie A', 'Bundesliga', 'Ligue 1'];
        const teams = [
            'Manchester United', 'Liverpool', 'Real Madrid', 'Barcelona', 'Bayern Munich',
            'Juventus', 'PSG', 'Chelsea', 'Arsenal', 'AC Milan', 'Inter Milan', 'Dortmund'
        ];

        /**
         * Generates mock data for upcoming matches.
         */
        function generateMockUpcomingMatches() {
            const matches = [];
            const count = 6; 
            const now = new Date();

            for (let i = 0; i < count; i++) {
                // Determine kickoff time within the next 30 minutes
                const minutesOffset = Math.floor(Math.random() * 25) + 5; // 5 to 30 mins
                const kickoffTime = new Date(now.getTime() + minutesOffset * 60000);
                const timeString = kickoffTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

                // Pick random teams and league
                let home = teams[Math.floor(Math.random() * teams.length)];
                let away = teams[Math.floor(Math.random() * teams.length)];
                while (home === away) { // Ensure teams are different
                    away = teams[Math.floor(Math.random() * teams.length)];
                }
                const league = leagues[Math.floor(Math.random() * leagues.length)];
                
                // Generate mock odds
                const homeOdd = (Math.random() * 2 + 1).toFixed(2);
                const drawOdd = (Math.random() * 2 + 2.5).toFixed(2);
                const awayOdd = (Math.random() * 2 + 1).toFixed(2);

                matches.push({
                    home,
                    away,
                    league,
                    timeString,
                    homeOdd,
                    drawOdd,
                    awayOdd
                });
            }
            return matches;
        }

        /**
         * Renders the mock upcoming matches in the horizontal scroller.
         */
        function renderUpcomingMatches() {
            const matches = generateMockUpcomingMatches();
            upcomingScroller.innerHTML = matches.map(match => `
                <div class="match-card">
                    <p class="text-xs font-semibold uppercase text-yellow-400 mb-1">${match.league}</p>
                    <div class="text-lg font-extrabold mb-3">
                        ${match.home} <span class="text-gray-400">vs</span> ${match.away}
                    </div>
                    <div class="flex items-center justify-between text-sm font-medium mb-3 border-b border-gray-700 pb-2">
                        <span class="text-red-400">Kickoff:</span>
                        <span class="text-white bg-red-600 px-2 py-0.5 rounded-full">${match.timeString}</span>
                    </div>
                    
                    <div class="flex justify-between items-center text-xs font-semibold text-gray-400">
                        <span>Odds (H/D/A)</span>
                        <div class="flex space-x-2">
                            <span class="bg-gray-700 text-green-300 px-2 py-1 rounded-md">${match.homeOdd}</span>
                            <span class="bg-gray-700 text-cyan-300 px-2 py-1 rounded-md">${match.drawOdd}</span>
                            <span class="bg-gray-700 text-red-300 px-2 py-1 rounded-md">${match.awayOdd}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }


        // --- Initialization ---

        async function fetchData() {
            loadingIndicator.classList.remove('hidden');
            messageBox.classList.add('hidden');
            
            try {
                const response = await fetch(CSV_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                
                allData = parseCSV(csvText);
                currentData = [...allData];

                if (allData.length === 0) {
                    messageBox.classList.remove('hidden');
                    messageBox.querySelector('p:first-child').textContent = 'The sheet is empty or could not be parsed.';
                }

                initializeFilters();
                renderTable();

            } catch (error) {
                console.error('Error fetching or parsing data:', error);
                messageBox.classList.remove('hidden');
                messageBox.querySelector('p:first-child').textContent = 'Failed to fetch data from Google Sheet.';
            } finally {
                loadingIndicator.classList.add('hidden');
            }
            
            // Render upcoming matches on load
            renderUpcomingMatches();
        }

        // Start the application
        window.onload = fetchData;

    </script>
</body>
</html>
