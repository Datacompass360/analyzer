<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataCompass 360 - Smart Football Insights</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js for Dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'naviblue': '#0a0a2a',
                        'accent-green': '#10b981',
                        'light-green-bg': '#f0fff4',
                        'popup-bg': '#e6f2ff', // Light blue
                        'popup-text': '#003366', // Dark navy
                    },
                    fontFamily: { sans: ['Poppins', 'sans-serif'] },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap');
        
        :root {
            --naviblue: #0a0a2a;
            --accent-green: #10b981;
            --glow-color: rgba(16, 185, 129, 0.7);
        }

        body { font-family: 'Poppins', sans-serif; background-color: #f0f2f5; }

        @keyframes glowing { 0%, 100% { box-shadow: 0 0 5px var(--glow-color), 0 0 10px var(--glow-color); } 50% { box-shadow: 0 0 20px var(--glow-color), 0 0 30px var(--glow-color); } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes twinkle {
            0% { box-shadow: 0 0 5px #34d399, 0 0 10px #34d399; }
            50% { box-shadow: 0 0 15px #6ee7b7, 0 0 25px #6ee7b7; }
            100% { box-shadow: 0 0 5px #34d399, 0 0 10px #34d399; }
        }

        .glassmorphic { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .pill-switcher { display: inline-flex; padding: 0.35rem; border-radius: 9999px; position: relative; }
        .pill-switcher button { transition: color 0.3s ease, transform 0.2s ease; z-index: 10; }
        .pill-switcher button.active-tab { color: white; transform: scale(1.05); text-shadow: 0 0 10px rgba(0,0,0,0.5); }
        .pill-switcher .glider { position: absolute; height: 100%; top: 0; left: 0; background-image: linear-gradient(to right, var(--accent-green), #059669); border-radius: 9999px; box-shadow: 0 4px 15px -3px rgba(16, 185, 129, 0.5); transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94), width 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); z-index: 5; }
        
        .interactive-scale:hover { transform: translateY(-3px) scale(1.03); }
        
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(10, 10, 42, 0.8); backdrop-filter: blur(5px);
            display: flex; align-items: center; justify-content: center; z-index: 50;
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
        }
        .modal-backdrop.active { opacity: 1; pointer-events: auto; animation: fadeIn 0.3s ease forwards; }
        .modal-content { opacity: 0; }
        .modal-content.active { animation: slideUp 0.4s ease-out forwards; opacity: 1; }
        
        #data-table thead th, #favorites-table thead th { background-color: var(--naviblue) !important; color: white !important; font-weight: 800 !important; }
        #data-table tbody tr:hover, #favorites-table tbody tr:hover { background-image: linear-gradient(to right, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0)); transform: scale(1.01); transition: transform 0.2s ease; box-shadow: 0 4px 20px rgba(0,0,0,0.05); border-left: 4px solid var(--accent-green); cursor: pointer; }
        .viewed-row { background-color: #d1fae5 !important; } /* A slightly different green for viewed */
        
        .sort-icon { transition: transform 0.3s ease; }
        @keyframes scroll { from { transform: translateX(0); } to { transform: translateX(-100%); } }
        .scroller-inner { display: flex; flex-wrap: nowrap; width: fit-content; animation: scroll 60s linear infinite; }
        .match-scroller:hover .scroller-inner { animation-play-state: paused; }
        
        .star-icon { cursor: pointer; transition: transform 0.2s, color 0.2s; }
        .star-icon:hover { transform: scale(1.3); }
        .star-icon.favorited { color: #facc15; }

        .glow-win { animation: twinkle 2s infinite ease-in-out; }

        /* Animated Logo Styles */
        #animated-logo .compass-needle {
            transform-origin: center;
            animation: spin 8s linear infinite;
        }
        #animated-logo .graph-line {
            stroke-dasharray: 100;
            stroke-dashoffset: 100;
            animation: dash 3s ease-in-out infinite alternate;
        }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes dash { to { stroke-dashoffset: 0; } }

        /* Summary Table Styles */
        #summary-table-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out, padding 0.5s ease-out;
            padding: 0;
        }
         #summary-table-container.active {
            max-height: 500px; /* Adjust as needed */
            padding: 24px;
        }

    </style>
</head>
<body class="p-4 md:p-8 bg-gray-100">

    <div class="max-w-7xl mx-auto mb-6 flex justify-between items-center">
        <!-- Animated Logo -->
        <div id="animated-logo" class="w-16 h-16">
             <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <circle cx="50" cy="50" r="45" fill="none" stroke="var(--naviblue)" stroke-width="4"/>
                <path class="graph-line" d="M 20 60 Q 40 30, 60 50 T 80 40" fill="none" stroke="var(--accent-green)" stroke-width="4" stroke-linecap="round"/>
                <g class="compass-needle">
                    <path d="M 50 10 L 45 50 L 50 90 L 55 50 Z" fill="#ef4444"/>
                    <path d="M 50 10 L 45 50 L 50 90 L 55 50 Z" fill-opacity="0.5" fill="white"/>
                </g>
                <circle cx="50" cy="50" r="5" fill="var(--naviblue)"/>
            </svg>
        </div>
        <div id="nav-container" class="pill-switcher glassmorphic">
            <span id="glider" class="glider"></span>
            <button id="tab-dashboard" onclick="handleTabClick('dashboard')" class="flex-1 py-3 px-6 rounded-full text-sm font-bold">Dashboard</button>
            <button id="tab-all" onclick="handleTabClick('all')" class="flex-1 py-3 px-6 rounded-full text-sm font-bold">All Matches</button>
            <button id="tab-best" onclick="handleTabClick('best')" class="flex-1 py-3 px-6 rounded-full text-sm font-bold">Best Tips</button>
            <button id="tab-extrapolation" onclick="handleTabClick('extrapolation')" class="flex-1 py-3 px-6 rounded-full text-sm font-bold text-center">Winning Extrapolation</button>
            <button id="tab-favorites" onclick="handleTabClick('favorites')" class="flex-1 py-3 px-6 rounded-full text-sm font-bold">Favorites</button>
        </div>
        <div class="w-16 h-16"></div> <!-- Spacer to balance the logo -->
    </div>

    <div class="max-w-7xl mx-auto">
        <header class="mb-8 p-8 bg-gradient-to-br from-naviblue via-indigo-900 to-black shadow-2xl rounded-2xl text-center overflow-hidden">
            <h1 class="text-4xl md:text-5xl font-extrabold text-white mt-4">DataCompass 360</h1>
            <p class="text-white/70 mt-2 text-sm md:text-base">Smart Football Insights Dashboard</p>
        </header>

        <div id="loading-indicator" class="mb-6 p-4 bg-accent-green/10 border border-accent-green/30 text-sm font-medium text-naviblue rounded-lg flex items-center justify-center hidden"><svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-accent-green" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></path><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Loading Data...</div>

        <div id="filters-panel" class="mb-6 p-6 bg-blue-100 shadow-xl rounded-2xl relative hidden">
             <div class="flex justify-between items-center mb-6">
                 <h2 class="text-2xl font-extrabold text-gray-800 flex items-center"><svg class="w-6 h-6 mr-3 text-accent-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414A1 1 0 0012 15.586V21h-2v-5.414a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path></svg>Refine Insights</h2>
                 <button onclick="clearFilters()" class="px-4 py-2 text-sm font-bold bg-red-500 text-white rounded-lg hover:bg-red-600 transition flex items-center"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>Clear Filters</button>
             </div>
             <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-7 gap-4">
                  <div class="relative"><label class="block text-sm font-semibold text-gray-700 mb-2">Search</label><input type="text" id="team-search-input" placeholder="e.g., Chelsea" class="w-full p-3 border border-gray-300 rounded-xl shadow-sm" oninput="handleFilterChange()"></div>
                  <div class="relative"><label class="block text-sm font-semibold text-gray-700 mb-2">Match Date</label><select id="filter-date" onchange="handleFilterChange()" class="w-full p-3 border border-gray-300 rounded-xl shadow-sm"></select></div>
                  <div class="relative"><label class="block text-sm font-semibold text-gray-700 mb-2">League</label><select id="filter-league" onchange="handleFilterChange()" class="w-full p-3 border border-gray-300 rounded-xl shadow-sm"></select></div>
                  <div class="relative"><label class="block text-sm font-semibold text-gray-700 mb-2">Prediction</label><select id="filter-prediction" onchange="handleFilterChange()" class="w-full p-3 border border-gray-300 rounded-xl shadow-sm"></select></div>
                  <div class="relative"><label class="block text-sm font-semibold text-gray-700 mb-2">Match Analysis</label><select id="main-filter-match-analysis" onchange="handleFilterChange()" class="w-full p-3 border border-gray-300 rounded-xl shadow-sm"></select></div>
                  <div class="relative"><label class="block text-sm font-semibold text-gray-700 mb-2">Goals Analysis</label><select id="main-filter-goals-analysis" onchange="handleFilterChange()" class="w-full p-3 border border-gray-300 rounded-xl shadow-sm"></select></div>
                  <div class="relative"><label class="block text-sm font-semibold text-gray-700 mb-2">Home Odds (Min)</label><input type="number" id="filter-home-odds" placeholder="e.g., 1.5" class="w-full p-3 border border-gray-300 rounded-xl shadow-sm" oninput="handleFilterChange()"></div>
             </div>
             <button onclick="showFilterModal()" class="absolute -bottom-5 right-6 px-5 py-3 bg-accent-green text-white font-bold rounded-full shadow-lg hover:bg-accent-green/90 transition flex items-center" style="animation: glowing 3s infinite ease-in-out;"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 6V4m0 16v-2m8-6h2m-16 0H4m14.243-7.757l1.414-1.414M5.343 18.657l-1.414 1.414m14.142 0l-1.414-1.414M6.757 5.343l-1.414-1.414M12 18a6 6 0 100-12 6 6 0 000 12z"></path></svg>More Filters</button>
        </div>

        <div id="main-content" class="hidden">
            <div class="mt-12 p-1 bg-naviblue rounded-2xl shadow-2xl overflow-hidden">
                <div id="upcoming-matches-scroller" class="match-scroller"><div class="scroller-inner"></div></div>
            </div>
            <div id="table-container" class="bg-white shadow-2xl rounded-2xl overflow-hidden mt-12">
                <div class="overflow-x-auto"><table id="data-table" class="min-w-full"><thead class="sticky top-0 z-10"><tr></tr></thead><tbody id="table-body" class="divide-y divide-gray-100"></tbody><tfoot id="table-footer" class="hidden bg-gray-50"></tfoot></table></div>
                <div id="message-box" class="p-8 text-center hidden"><p class="text-lg font-semibold text-naviblue">No data found.</p></div>
            </div>
             <!-- Summary Table Container -->
            <div id="summary-table-container" class="bg-popup-bg shadow-2xl rounded-2xl overflow-hidden mt-6">
                 <div id="summary-content" class="p-6"></div>
            </div>
            <div id="pagination-controls" class="mt-6 flex justify-between items-center hidden"></div>
        </div>
        
        <div id="dashboard-content" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <div class="p-6 bg-white rounded-2xl shadow-lg"><h3 class="text-sm font-bold text-gray-500">WIN RATE</h3><p id="stat-win-rate" class="text-3xl font-extrabold text-accent-green mt-1">0%</p></div>
                <div class="p-6 bg-white rounded-2xl shadow-lg"><h3 class="text-sm font-bold text-gray-500">PREDICTION ACCURACY</h3><p id="stat-accuracy" class="text-3xl font-extrabold text-naviblue mt-1">0%</p></div>
                <div class="p-6 bg-white rounded-2xl shadow-lg"><h3 class="text-sm font-bold text-gray-500">TOTAL TIPS</h3><p id="stat-total-tips" class="text-3xl font-extrabold text-gray-700 mt-1">0</p></div>
                <div class="p-6 bg-white rounded-2xl shadow-lg"><h3 class="text-sm font-bold text-gray-500">TOP TIP</h3><p id="stat-top-tip" class="text-xl font-bold text-naviblue mt-1">N/A</p></div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 place-items-center">
                <div class="p-6 bg-white rounded-2xl shadow-lg w-full flex flex-col items-center">
                    <h3 class="text-lg font-bold text-naviblue mb-4">Outcome Distribution</h3>
                    <div class="relative w-full max-w-[480px] aspect-square">
                        <canvas id="outcome-pie-chart"></canvas>
                    </div>
                </div>
                <div class="p-6 bg-white rounded-2xl shadow-lg w-full flex flex-col items-center">
                    <h3 class="text-lg font-bold text-naviblue mb-4">Prediction vs. Result</h3>
                    <div class="relative w-full max-w-[480px] aspect-square">
                        <canvas id="prediction-bar-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div id="favorites-content" class="hidden">
            <div class="bg-white shadow-2xl rounded-2xl overflow-hidden p-6">
                 <div class="flex justify-between items-center mb-4">
                     <h2 class="text-2xl font-extrabold text-naviblue">‚≠ê Your Favorite Matches</h2>
                     <button id="download-pdf-btn" onclick="downloadFavoritesPDF()" class="px-4 py-2 text-sm font-bold bg-accent-green text-white rounded-lg hover:bg-green-600 transition flex items-center"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>Download PDF</button>
                 </div>
                 <div id="favorites-table-container" class="overflow-x-auto"></div>
            </div>
            <!-- Favorites Summary Table Container -->
            <div id="favorites-summary-table-container" class="bg-popup-bg shadow-2xl rounded-2xl overflow-hidden mt-6">
                 <div id="favorites-summary-content" class="p-6"></div>
            </div>
        </div>
    </div>
    
    <div id="details-modal" class="modal-backdrop" onclick="hideDetailsModal(event)"></div>
    <div id="more-filters-modal" class="modal-backdrop" onclick="hideFilterModal(event)"></div>

    <script type="text/javascript">
    const { jsPDF } = window.jspdf;
    // --- Configuration ---
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQH-Uue5Ctuo4aU-4S81U9QvoXxslOq6YjKHnVkPjyOeJqci4p19cs2iZ8y5GgzsSh_vQHxPYb-gl-5/pub?gid=0&single=true&output=csv';
    const HIDDEN_COLUMNS = ['Home Team', 'Away Team', 'Home Wins', 'Home Draws', 'Home Losses', 'Away Wins', 'Away Draws', 'Away Losses', 'Home Avg Scored', 'Home Conceded', 'Home Avg Conceded', 'Away Avg Scored', 'Away Conceded', 'Away Avg Conceded', 'Match Analysis', 'Goals Analysis'];
    
    const COLUMN_MAP = [
        { key: 'Match Date', label: 'Date' }, { key: 'League', label: 'League' }, { key: 'Match', label: 'Match' }, { key: 'Prediction', label: 'Prediction' }, { key: 'Outcome', label: 'Outcome' }, { key: 'Result', label: 'Result' }, { key: 'Correct Score', label: 'Score' }, { key: 'Home Odds', label: '1', type: 'number' }, { key: 'Draw Odds', label: 'X', type: 'number' }, { key: 'Away Odds', label: '2', type: 'number' }, 
        { key: 'Home Team', type: 'string' }, { key: 'Away Team', type: 'string' }, { key: 'Winning Streak', type: 'number' }, { key: 'Losing Streak', type: 'number' }, { key: 'Stake', type: 'number' }, { key: 'Home Wins', type: 'number' }, { key: 'Home Draws', type: 'number' }, { key: 'Home Losses', type: 'number' }, { key: 'Away Wins', type: 'number' }, { key: 'Away Draws', type: 'number' }, { key: 'Away Losses', type: 'number' }, { key: 'Home Team Scored', type: 'number' }, { key: 'Home Avg Scored', type: 'number' }, { key: 'Home Conceded', type: 'number' }, { key: 'Home Avg Conceded', type: 'number' }, { key: 'Away Team Scored', type: 'number' }, { key: 'Away Avg Scored', type: 'number' }, { key: 'Away Conceded', type: 'number' }, { key: 'Away Avg Conceded', type: 'number' }, { key: 'Match Analysis', type: 'string' }, { key: 'Goals Analysis', type: 'string' }
    ];

    let allData = [], currentData = [], favorites = [], viewedRows = new Set(), outcomeChart, predictionChart, filteredFavorites = [], lostMatches = new Set();
    let sortColumn = 'Match Date', sortDirection = 'desc', rowsPerPage = 30, currentPage = 1, activeTab = 'dashboard';
    const initialFilters = { 
        league: 'All', prediction: 'All', teamSearch: '', matchAnalysis: 'All', goalsAnalysis: 'All',
        matchDate: 'All Dates', homeOddsMin: null,
        winningStreak: null, losingStreak: null,
        homeOddsAdvancedMin: null, homeOddsAdvancedMax: null,
        drawOddsMin: null, drawOddsMax: null,
        awayOddsMin: null, awayOddsMax: null
    };
    let filters = { ...initialFilters };

    const dom = {
        loading: document.getElementById('loading-indicator'),
        mainContent: document.getElementById('main-content'),
        dashboardContent: document.getElementById('dashboard-content'),
        favoritesContent: document.getElementById('favorites-content'),
        tableBody: document.getElementById('table-body'),
        tableHeadRow: document.querySelector('#data-table thead tr'),
        tableFooter: document.getElementById('table-footer'),
        messageBox: document.getElementById('message-box'),
        pagination: document.getElementById('pagination-controls'),
        glider: document.getElementById('glider'),
        detailsModal: document.getElementById('details-modal'),
        filtersModal: document.getElementById('more-filters-modal'),
        filtersPanel: document.getElementById('filters-panel'),
        summaryContainer: document.getElementById('summary-table-container'),
        summaryContent: document.getElementById('summary-content'),
        favoritesSummaryContainer: document.getElementById('favorites-summary-table-container'),
        favoritesSummaryContent: document.getElementById('favorites-summary-content')
    };

    const icons = {
        win: 'üèÜ', draw: 'ü§ù', loss: '‚ùå', goal: '‚öΩ', average: 'üìä', analysis: 'üîç', streak: 'üî•', odds: 'üìà', score: 'üéØ', prediction: 'üîÆ', outcome: 'üèÅ', result: '‚úÖ', stake: 'üí∞'
    };

    const parseCSV = (csvText) => {
        const lines = csvText.trim().split("\n");
        const headers = lines[0].split(",").map(h => h.trim().replace(/"/g, ""));
        return lines.slice(1).map(line => {
            if (!line.trim()) return null;
            const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.trim().replace(/"/g, ''));
            const rowObject = {};
            COLUMN_MAP.forEach(col => {
                const index = headers.indexOf(col.key);
                if (col.key === 'Result' && index === -1) {
                    const scoreIndex = headers.indexOf('Correct Score');
                    if (scoreIndex !== -1) {
                         rowObject[col.key] = values[scoreIndex] || "";
                    } else {
                         rowObject[col.key] = "";
                    }
                } else if (index !== -1 && values[index] !== undefined) {
                    rowObject[col.key] = col.type === 'number' ? (isNaN(parseFloat(values[index])) ? null : parseFloat(values[index])) : values[index];
                } else {
                    rowObject[col.key] = col.type === 'number' ? null : "";
                }
            });
            // Assign a unique ID for tracking state
            rowObject.uniqueId = `${rowObject.Match}-${rowObject['Match Date']}`;
            return rowObject;
        }).filter(row => row && row.Match);
    };

    const applyFilters = () => {
        currentPage = 1;
        let sourceData = (activeTab === 'favorites') ? favorites : allData;
        let filteredData = sourceData;

        if (activeTab === 'best') {
            const bestTipsValues = ["Best Away Tip", "Best Home Tip", "Home Tip", "Good Away Tip", "Home Good Tip", "Away Tip"];
            filteredData = filteredData.filter(item => bestTipsValues.includes(item["Match Analysis"]));
        }
        
        if (activeTab === 'extrapolation') {
            const extrapolationValues = ["Best Away Tip", "Best Home Tip", "Home Good Tip"];
            filteredData = filteredData.filter(item => extrapolationValues.includes(item["Match Analysis"]));
            lostMatches.clear(); // Clear losses when filters change
        }

        const searchTerm = filters.teamSearch.toLowerCase().trim();
        if (searchTerm) filteredData = filteredData.filter(item => item.Match.toLowerCase().includes(searchTerm));
        if (filters.league !== 'All') filteredData = filteredData.filter(item => item.League === filters.league);
        if (filters.prediction !== 'All') filteredData = filteredData.filter(item => item.Prediction === filters.prediction);
        if (filters.matchDate !== 'All Dates') filteredData = filteredData.filter(item => item['Match Date'] === filters.matchDate);
        if (filters.homeOddsMin) filteredData = filteredData.filter(item => item['Home Odds'] >= filters.homeOddsMin);
        if (filters.winningStreak) filteredData = filteredData.filter(item => (item['Winning Streak'] || 0) >= filters.winningStreak);
        if (filters.losingStreak) filteredData = filteredData.filter(item => (item['Losing Streak'] || 0) >= filters.losingStreak);
        if (filters.matchAnalysis !== 'All') filteredData = filteredData.filter(item => item['Match Analysis'] === filters.matchAnalysis);
        if (filters.goalsAnalysis !== 'All') filteredData = filteredData.filter(item => item['Goals Analysis'] === filters.goalsAnalysis);
        
        const oddsFilters = [
            { key: 'Home Odds', min: filters.homeOddsAdvancedMin, max: filters.homeOddsAdvancedMax },
            { key: 'Draw Odds', min: filters.drawOddsMin, max: filters.drawOddsMax },
            { key: 'Away Odds', min: filters.awayOddsMin, max: filters.awayOddsMax },
        ];
        oddsFilters.forEach(f => {
            if (f.min) filteredData = filteredData.filter(item => item[f.key] >= f.min);
            if (f.max) filteredData = filteredData.filter(item => item[f.key] <= f.max);
        });
        
        if (activeTab === 'extrapolation') {
             // First pass: determine initial loss status based on rules
            filteredData.forEach(item => {
                const prediction = (item.Prediction || '').toLowerCase();
                const outcome = (item.Outcome || '').toLowerCase();
                
                let isLoss = true;
                if (!outcome || outcome === 'n/a') isLoss = false;
                if (prediction.includes('home') && outcome.includes('home')) isLoss = false;
                if (prediction.includes('away') && outcome.includes('away')) isLoss = false;
                if (prediction.includes('draw') && outcome.includes('draw')) isLoss = false;

                if (isLoss) {
                    lostMatches.add(item.uniqueId);
                }
            });

            // Second pass: calculate all values for each item
            filteredData.forEach(item => {
                let oddsPrediction = null;
                const prediction = (item.Prediction || '').toLowerCase();
                if (prediction.includes('home')) oddsPrediction = item['Home Odds'];
                else if (prediction.includes('away')) oddsPrediction = item['Away Odds'];
                else if (prediction.includes('draw')) oddsPrediction = item['Draw Odds'];
                
                item.oddsPrediction = oddsPrediction;
                item.totalStake = item.Match ? 100 : 0;

                const isLost = lostMatches.has(item.uniqueId);
                if (isLost) {
                    item.potentialWinning = 0;
                    item.profit = -100;
                } else {
                    item.potentialWinning = oddsPrediction ? (oddsPrediction * 100) : 0;
                    item.profit = item.potentialWinning - item.totalStake;
                }
            });
        }

        if (activeTab === 'dashboard') renderDashboard(filteredData);
        else if (activeTab === 'favorites') { filteredFavorites = filteredData; renderFavorites(); }
        else { currentData = filteredData; applySort(); }
    };

    const applySort = () => {
        currentData.sort((a, b) => {
            const valA = a[sortColumn], valB = b[sortColumn];
            if (sortColumn === 'Match Date') {
                 const dateA = new Date(valA.split('/').reverse().join('-'));
                 const dateB = new Date(valB.split('/').reverse().join('-'));
                 return sortDirection === 'asc' ? dateA - dateB : dateB - dateA;
            }
            if (typeof valA === 'number') return sortDirection === 'asc' ? (valA || 0) - (valB || 0) : (valB || 0) - (valA || 0);
            return sortDirection === 'asc' ? String(valA || "").localeCompare(String(valB || "")) : String(valB || "").localeCompare(String(valA || ""));
        });
        renderTableHead();
        renderPage();
    };

    const renderTableHead = () => {
        let headHTML = '';
        if (activeTab === 'extrapolation') {
            const extrapolationCols = [
                { key: 'Match Date', label: 'Date' },
                { key: 'League', label: 'League' },
                { key: 'Match', label: 'Match' },
                { key: 'Prediction', label: 'Prediction' },
                { key: 'Outcome', label: 'Outcome' },
                { key: 'oddsPrediction', label: 'Odds'},
                { key: 'totalStake', label: 'Stake'},
                { key: 'potentialWinning', label: 'Potential Win'},
                { key: 'profit', label: 'Profit'},
                { key: 'isLoss', label: 'Loss?'} // Not sortable
            ];
            headHTML += '<th></th>'; // Star
            extrapolationCols.forEach(col => {
                if (col.key === 'isLoss') {
                    headHTML += `<th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">${col.label}</th>`;
                } else {
                    headHTML += `<th onclick="handleSort('${col.key}')" class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider cursor-pointer"><div class="flex items-center">${col.label}${col.key === sortColumn ? `<svg class="w-4 h-4 ml-2 sort-icon ${sortDirection === 'desc' ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5 15l7-7 7 7"></path></svg>` : ''}</div></th>`;
                }
                if (col.key === 'Match Date') {
                    headHTML += '<th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">Actions</th>'; // View button header
                }
            });
        } else {
            const visibleCols = COLUMN_MAP.filter(c => c.label && !HIDDEN_COLUMNS.includes(c.key));
            headHTML += '<th></th>'; // Star
            visibleCols.forEach(col => {
                headHTML += `<th onclick="handleSort('${col.key}')" class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider cursor-pointer"><div class="flex items-center">${col.label}${col.key === sortColumn ? `<svg class="w-4 h-4 ml-2 sort-icon ${sortDirection === 'desc' ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5 15l7-7 7 7"></path></svg>` : ''}</div></th>`;
                if (col.key === 'Match Date') {
                     headHTML += '<th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">Actions</th>'; // View button header
                }
            });
        }
        dom.tableHeadRow.innerHTML = headHTML;
    };

    const renderPage = () => {
        const totalPages = Math.ceil(currentData.length / rowsPerPage);
        const start = (currentPage - 1) * rowsPerPage;
        renderTableBody(currentData.slice(start, start + rowsPerPage));
        dom.pagination.innerHTML = currentData.length > rowsPerPage ? `<button onclick="handlePrevPage()" class="px-4 py-2 text-sm font-medium rounded-full bg-white shadow" ${currentPage === 1 ? 'disabled' : ''}>Prev</button><span class="text-sm font-semibold">Page ${currentPage} of ${totalPages}</span><button onclick="handleNextPage()" class="px-4 py-2 text-sm font-medium rounded-full bg-white shadow" ${currentPage === totalPages || totalPages === 0 ? 'disabled' : ''}>Next</button>` : "";
        dom.pagination.classList.toggle('hidden', currentData.length <= rowsPerPage);
        dom.tableFooter.classList.toggle('hidden', activeTab !== 'extrapolation');
        if (activeTab === 'extrapolation') updateTotals();
    };

    const renderTableBody = (data) => {
        dom.tableBody.innerHTML = "";
        if (data.length === 0) {
            dom.messageBox.classList.remove("hidden");
            dom.messageBox.querySelector("p").textContent = "No results match your criteria.";
            return;
        }
        dom.messageBox.classList.add("hidden");

        if (activeTab === 'extrapolation') {
            renderExtrapolationTable(data);
        } else {
            renderStandardTable(data);
        }
    };
    
    const renderStandardTable = (data) => {
        const visibleCols = COLUMN_MAP.filter(c => c.label && !HIDDEN_COLUMNS.includes(c.key));
        data.forEach(item => {
            const row = document.createElement("tr");
            const itemJSON = encodeURIComponent(JSON.stringify(item));
            row.className = `transition-all duration-200 ${viewedRows.has(item.uniqueId) ? "viewed-row" : ""}`;
            row.onclick = () => handleRowClick(item);

            let rowHTML = `<td class="px-2 py-3 text-center"><span onclick="event.stopPropagation(); toggleFavorite('${item.uniqueId}')" class="star-icon text-2xl ${favorites.some(f => f.uniqueId === item.uniqueId) ? "favorited" : ""}">${favorites.some(f => f.uniqueId === item.uniqueId) ? '‚≠ê' : '‚òÜ'}</span></td>`;
            const viewButtonHTML = `<td class="px-4 py-3"><button onclick="event.stopPropagation(); showDetailsModal(JSON.parse(decodeURIComponent('${itemJSON}')))" class="px-3 py-1 text-xs font-bold bg-blue-500 text-white rounded-full hover:bg-blue-600">View</button></td>`;

            visibleCols.forEach(col => {
                const value = item[col.key] || "N/A";
                if (col.key === 'Outcome') {
                    const [bgColor, text, isWin] = getOutcomeColor(item.Prediction, value);
                    rowHTML += `<td class="px-4 py-3 whitespace-nowrap text-sm"><span class="px-3 py-1 text-xs font-bold rounded-full text-white ${bgColor} shadow-md ${isWin ? 'glow-win' : ''}">${text}</span></td>`;
                } else {
                    rowHTML += `<td class="px-4 py-3 whitespace-nowrap text-sm">${value}</td>`;
                }
                if (col.key === 'Match Date') {
                    rowHTML += viewButtonHTML;
                }
            });
            row.innerHTML = rowHTML;
            dom.tableBody.appendChild(row);
        });
    };
    
    const renderExtrapolationTable = (data) => {
        data.forEach(item => {
            const row = document.createElement("tr");
            const itemJSON = encodeURIComponent(JSON.stringify(item));
            row.className = `transition-all duration-200 ${viewedRows.has(item.uniqueId) ? "viewed-row" : ""}`;
            row.onclick = () => handleRowClick(item);

            const isFavorited = favorites.some(f => f.uniqueId === item.uniqueId);
            const isLost = lostMatches.has(item.uniqueId);

            let rowHTML = `
                <td class="px-2 py-3 text-center"><span onclick="event.stopPropagation(); toggleFavorite('${item.uniqueId}')" class="star-icon text-2xl ${isFavorited ? "favorited" : ""}">${isFavorited ? '‚≠ê' : '‚òÜ'}</span></td>
                <td class="px-4 py-3 whitespace-nowrap text-sm">${item['Match Date'] || 'N/A'}</td>
                <td class="px-4 py-3"><button onclick="event.stopPropagation(); showDetailsModal(JSON.parse(decodeURIComponent('${itemJSON}')))" class="px-3 py-1 text-xs font-bold bg-blue-500 text-white rounded-full hover:bg-blue-600">View</button></td>
                <td class="px-4 py-3 whitespace-nowrap text-sm">${item.League || 'N/A'}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm">${item.Match || 'N/A'}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm">${item.Prediction || 'N/A'}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm">${item.Outcome || 'N/A'}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm font-bold">${(item.oddsPrediction && typeof item.oddsPrediction === 'number') ? item.oddsPrediction.toFixed(2) : 'N/A'}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm font-bold">${(item.totalStake || 0).toFixed(2)}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm font-bold text-accent-green">${(item.potentialWinning || 0).toFixed(2)}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm font-bold ${item.profit >= 0 ? 'text-green-600' : 'text-red-500'}">${(item.profit || 0).toFixed(2)}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-center">
                    <input type="checkbox" class="h-5 w-5 rounded border-gray-300 text-red-600 focus:ring-red-500" ${isLost ? 'checked' : ''} onclick="event.stopPropagation(); handleLossToggle('${item.uniqueId}', this.checked)">
                </td>
            `;
            row.innerHTML = rowHTML;
            dom.tableBody.appendChild(row);
        });
    }

    const getOutcomeColor = (prediction, outcome) => {
        if (!prediction || !outcome || outcome === "N/A" || outcome.trim() === '') return ["bg-gray-400", "Pending", false];
        const p = prediction.toLowerCase(), o = outcome.toLowerCase();
        if ((p.includes("home") && o.includes("home")) || (p.includes("away") && o.includes("away")) || (p.includes("draw") && o.includes("draw"))) {
            return ["bg-accent-green", outcome, true];
        }
        return ["bg-red-500", outcome, false];
    };
    
    const renderFavorites = () => {
        const container = document.getElementById('favorites-table-container');
        if (filteredFavorites.length === 0) {
            container.innerHTML = `<div class="p-8 text-center"><p class="text-lg font-semibold text-naviblue">You haven't favorited any matches yet.</p></div>`;
            return;
        }

        const headers = ['Date', 'League', 'Match', 'Prediction', 'Outcome', 'Result', 'Score'];
        const keys = ['Match Date', 'League', 'Match', 'Prediction', 'Outcome', 'Result', 'Correct Score'];

        let tableHTML = `<table id="favorites-table" class="min-w-full"><thead class="sticky top-0 z-10"><tr>`;
        tableHTML += `<th></th>` // Star icon
        headers.forEach(h => { 
            tableHTML += `<th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">${h}</th>`; 
            if (h === 'Date') {
                tableHTML += `<th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">Actions</th>`;
            }
        });
        tableHTML += `</tr></thead><tbody class="divide-y divide-gray-100">`;

        filteredFavorites.forEach(item => {
            const itemJSON = encodeURIComponent(JSON.stringify(item));
            const viewButtonHTML = `<td class="px-4 py-3"><button onclick="event.stopPropagation(); showDetailsModal(JSON.parse(decodeURIComponent('${itemJSON}')))" class="px-3 py-1 text-xs font-bold bg-blue-500 text-white rounded-full hover:bg-blue-600">View</button></td>`;

            tableHTML += `<tr class="transition-all duration-200" onclick="handleRowClick(item, true)">`;
            tableHTML += `<td class="px-2 py-3 text-center"><span onclick="event.stopPropagation(); toggleFavorite('${item.uniqueId}')" class="star-icon text-2xl favorited">‚≠ê</span></td>`;
            keys.forEach(key => {
                const value = item[key] || "N/A";
                if (key === 'Outcome') {
                    const [bgColor, text, isWin] = getOutcomeColor(item.Prediction, value);
                    tableHTML += `<td class="px-4 py-3 whitespace-nowrap text-sm"><span class="px-3 py-1 text-xs font-bold rounded-full text-white ${bgColor} shadow-md ${isWin ? 'glow-win' : ''}">${text}</span></td>`;
                } else {
                    tableHTML += `<td class="px-4 py-3 whitespace-nowrap text-sm">${value}</td>`;
                }
                if (key === 'Match Date') {
                    tableHTML += viewButtonHTML;
                }
            });
            tableHTML += `</tr>`;
        });

        tableHTML += `</tbody></table>`;
        container.innerHTML = tableHTML;
    };


    const handleRowClick = (item) => {
        viewedRows.add(item.uniqueId);
        renderSummaryTable(item);
        if (['all', 'best', 'favorites', 'extrapolation'].includes(activeTab)) {
            // Re-render the correct table to show the 'viewed-row' style
            const tableToUpdate = document.querySelector(`[onclick*="${item.uniqueId}"]`).closest('tr');
            if(tableToUpdate) tableToUpdate.classList.add('viewed-row');
        }
    };
    window.handleSort = (key) => { sortColumn === key ? sortDirection = (sortDirection === 'asc' ? 'desc' : 'asc') : (sortColumn = key, sortDirection = 'asc'); applySort(); };
    window.handleTabClick = (tab) => {
        activeTab = tab;
        dom.summaryContainer.classList.remove('active');
        dom.favoritesSummaryContainer.classList.remove('active');
        updateUiForTab();
    };
    window.handleFilterChange = () => {
        filters.league = document.getElementById("filter-league").value; 
        filters.prediction = document.getElementById("filter-prediction").value; 
        filters.teamSearch = document.getElementById("team-search-input").value;
        filters.matchDate = document.getElementById("filter-date").value;
        filters.homeOddsMin = parseFloat(document.getElementById("filter-home-odds").value) || null;
        filters.matchAnalysis = document.getElementById("main-filter-match-analysis").value;
        filters.goalsAnalysis = document.getElementById("main-filter-goals-analysis").value;
        applyFilters(); 
    };
    window.handleAdvancedFilterChange = () => {
        filters.winningStreak = parseFloat(document.getElementById("adv-filter-win-streak").value) || null;
        filters.losingStreak = parseFloat(document.getElementById("adv-filter-lose-streak").value) || null;
        filters.homeOddsAdvancedMin = parseFloat(document.getElementById("home-odds-min").value) || null;
        filters.homeOddsAdvancedMax = parseFloat(document.getElementById("home-odds-max").value) || null;
        filters.drawOddsMin = parseFloat(document.getElementById("draw-odds-min").value) || null;
        filters.drawOddsMax = parseFloat(document.getElementById("draw-odds-max").value) || null;
        filters.awayOddsMin = parseFloat(document.getElementById("away-odds-min").value) || null;
        filters.awayOddsMax = parseFloat(document.getElementById("away-odds-max").value) || null;
        hideFilterModal();
        applyFilters();
    };
    window.handlePrevPage = () => { if (currentPage > 1) { currentPage--; renderPage(); } };
    window.handleNextPage = () => { if (currentPage < Math.ceil(currentData.length / rowsPerPage)) { currentPage++; renderPage(); } };
    window.handleLossToggle = (uniqueId, isChecked) => {
        const item = currentData.find(d => d.uniqueId === uniqueId);
        if (!item) return;

        if (isChecked) {
            lostMatches.add(uniqueId);
            item.potentialWinning = 0;
            item.profit = -100;
        } else {
            lostMatches.delete(uniqueId);
            // Recalculate based on original odds
            item.potentialWinning = item.oddsPrediction ? (item.oddsPrediction * 100) : 0;
            item.profit = item.potentialWinning - item.totalStake;
        }
        renderPage(); // Re-render the table and totals
    };
    const updateTotals = () => {
        const totals = currentData.reduce((acc, item) => {
            const isLost = lostMatches.has(item.uniqueId);
            const stake = item.totalStake || 0;
            // Use the item's current values which are updated by handleLossToggle
            const potentialWinning = item.potentialWinning || 0;
            const profit = item.profit || 0;
            
            acc.stake += stake;
            acc.potentialWinning += potentialWinning;
            acc.profit += profit;
            
            return acc;
        }, { stake: 0, potentialWinning: 0, profit: 0 });

        // Total columns: Star, Date, Actions, League, Match, Prediction, Outcome, Odds, Stake, Win, Profit, Checkbox = 12
        dom.tableFooter.innerHTML = `
            <tr>
                <td colspan="8" class="px-4 py-4 text-right font-bold text-lg text-naviblue">Totals:</td>
                <td class="px-4 py-4 font-extrabold text-lg text-gray-700">${totals.stake.toFixed(2)}</td>
                <td class="px-4 py-4 font-extrabold text-lg text-accent-green">${totals.potentialWinning.toFixed(2)}</td>
                <td class="px-4 py-4 font-extrabold text-lg ${totals.profit >= 0 ? 'text-green-600' : 'text-red-500'}">${totals.profit.toFixed(2)}</td>
                <td></td>
            </tr>`;
    };

    const updateUiForTab = () => {
        const tabPositions = { dashboard: 0, all: 1, best: 2, extrapolation: 3, favorites: 4 };
        const numTabs = Object.keys(tabPositions).length;
        dom.glider.style.width = `${100 / numTabs}%`;
        dom.glider.style.transform = `translateX(${100 * tabPositions[activeTab]}%)`;
        Object.keys(tabPositions).forEach(t => document.getElementById(`tab-${t}`).classList.toggle("active-tab", t === activeTab));
        const isDashboard = activeTab === 'dashboard', isFavorites = activeTab === 'favorites';
        dom.dashboardContent.classList.toggle('hidden', !isDashboard);
        dom.favoritesContent.classList.toggle('hidden', !isFavorites);
        dom.mainContent.classList.toggle('hidden', isDashboard || isFavorites);
        dom.filtersPanel.classList.toggle('hidden', isDashboard);
        applyFilters();
    };
    
    window.showDetailsModal = (item) => {
        const isFavorited = favorites.some(f => f.uniqueId === item.uniqueId);
        const formatInt = (val) => val !== null && !isNaN(val) ? Math.round(val) : "N/A";
        const formatAvg = (val) => val !== null && !isNaN(val) ? val.toFixed(2) : "N/A";

        const statRow = (icon, category, homeVal, awayVal) => `
            <div class="grid grid-cols-3 gap-4 text-sm items-center py-2">
                <div class="text-right font-semibold">${homeVal}</div>
                <div class="text-center text-popup-text/80 flex items-center justify-center font-medium">${icon} <span class="ml-2">${category}</span></div>
                <div class="text-left font-semibold">${awayVal}</div>
            </div>`;

        const analysisBlock = (title, content) => content ? `
            <div class="mt-4">
                <h4 class="font-bold text-center mb-2">${title}</h4>
                <p class="text-xs text-center bg-black/5 p-3 rounded-md">${content}</p>
            </div>` : '';

        dom.detailsModal.innerHTML = `
            <div class="modal-content bg-popup-bg w-full max-w-lg mx-4 rounded-2xl shadow-2xl text-popup-text relative">
                <button onclick="hideDetailsModal()" class="absolute top-3 right-3 text-popup-text/50 hover:text-popup-text hover:bg-black/10 rounded-full p-2 transition z-10">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
                <div class="p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-grow">
                             <h3 class="text-2xl font-extrabold text-center">${item.Match}</h3>
                             <p class="text-center text-sm font-medium text-popup-text/80">${item.League} - ${item['Match Date']}</p>
                        </div>
                        <button onclick="toggleFavorite('${item.uniqueId}', true)" class="text-3xl transition-transform duration-200 hover:scale-125 -mt-1 ml-4">${isFavorited ? '‚≠ê' : '‚òÜ'}</button>
                    </div>
                    
                    <div class="bg-white/50 p-4 rounded-lg">
                        <div class="grid grid-cols-3 gap-4 text-sm font-bold text-popup-text/80 mb-2 border-b-2 border-popup-text/10 pb-2">
                            <div class="text-right">${item['Home Team']}</div>
                            <div class="text-center">Stats</div>
                            <div class="text-left">${item['Away Team']}</div>
                        </div>
                        <div class="divide-y divide-popup-text/10">
                            ${statRow(icons.win, 'Wins', formatInt(item['Home Wins']), formatInt(item['Away Wins']))}
                            ${statRow(icons.draw, 'Draws', formatInt(item['Home Draws']), formatInt(item['Away Draws']))}
                            ${statRow(icons.loss, 'Losses', formatInt(item['Home Losses']), formatInt(item['Away Losses']))}
                            ${statRow(icons.goal, 'Scored', formatInt(item['Home Team Scored']), formatInt(item['Away Team Scored']))}
                            ${statRow(icons.goal, 'Avg Scored', formatAvg(item['Home Avg Scored']), formatAvg(item['Away Avg Scored']))}
                            ${statRow(icons.average, 'Avg Conceded', formatAvg(item['Home Avg Conceded']), formatAvg(item['Away Avg Conceded']))}
                        </div>
                        ${analysisBlock('Match Analysis', item['Match Analysis'])}
                        ${analysisBlock('Goals Analysis', item['Goals Analysis'])}
                    </div>
                </div>
            </div>`;
        dom.detailsModal.classList.add('active');
        setTimeout(() => document.querySelector('#details-modal .modal-content').classList.add('active'), 10);
    };

    const renderSummaryTable = (item) => {
        const container = activeTab === 'favorites' ? dom.favoritesSummaryContainer : dom.summaryContainer;
        const contentEl = activeTab === 'favorites' ? dom.favoritesSummaryContent : dom.summaryContent;

        const summaryItem = (icon, category, value) => value ? `
            <div class="p-4 bg-white/50 rounded-lg text-center">
                <div class="text-2xl">${icon}</div>
                <p class="text-xs font-bold text-popup-text/70 mt-1">${category}</p>
                <p class="text-lg font-extrabold text-popup-text mt-1">${value}</p>
            </div>
        ` : '';

        const analysisItem = (icon, category, value) => value ? `
            <div class="p-4 bg-white/50 rounded-lg col-span-1 md:col-span-2">
                 <div class="flex items-center mb-2">
                    <span class="text-2xl mr-2">${icon}</span>
                    <p class="text-sm font-bold text-popup-text/70">${category}</p>
                </div>
                <p class="text-sm text-popup-text">${value}</p>
            </div>
        ` : '';

        const oddsValue = `1: ${item['Home Odds']} | X: ${item['Draw Odds']} | 2: ${item['Away Odds']}`;

        contentEl.innerHTML = `
            <h3 class="text-2xl font-extrabold text-popup-text text-center mb-4">${item.Match} - Summary</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                ${summaryItem(icons.prediction, 'Prediction', item.Prediction)}
                ${summaryItem(icons.outcome, 'Outcome', item.Outcome)}
                ${summaryItem(icons.result, 'Result', item.Result)}
                ${summaryItem(icons.score, 'Correct Score', item['Correct Score'])}
                ${summaryItem(icons.odds, 'Odds', oddsValue)}
                ${summaryItem(icons.stake, 'Stake', item.Stake)}
                ${summaryItem(icons.streak, 'Winning Streak', item['Winning Streak'])}
                ${summaryItem(icons.streak, 'Losing Streak', item['Losing Streak'])}
                ${analysisItem(icons.analysis, 'Match Analysis', item['Match Analysis'])}
                ${analysisItem(icons.analysis, 'Goals Analysis', item['Goals Analysis'])}
            </div>
        `;
        container.classList.add('active');
    };


    window.hideDetailsModal = (event) => {
        if (event && event.target !== dom.detailsModal && !event.target.closest('button[onclick^="hideDetailsModal"]')) return;
        const content = document.querySelector('#details-modal .modal-content');
        if (content) content.classList.remove('active');
        dom.detailsModal.classList.remove('active');
    };

    window.showFilterModal = () => {
        document.getElementById('adv-filter-win-streak').value = filters.winningStreak || '';
        document.getElementById('adv-filter-lose-streak').value = filters.losingStreak || '';
        document.getElementById('home-odds-min').value = filters.homeOddsAdvancedMin || '';
        document.getElementById('home-odds-max').value = filters.homeOddsAdvancedMax || '';
        document.getElementById('draw-odds-min').value = filters.drawOddsMin || '';
        document.getElementById('draw-odds-max').value = filters.drawOddsMax || '';
        document.getElementById('away-odds-min').value = filters.awayOddsMin || '';
        document.getElementById('away-odds-max').value = filters.awayOddsMax || '';
        
        dom.filtersModal.classList.add('active');
         setTimeout(() => document.querySelector('#more-filters-modal .modal-content').classList.add('active'), 10);
    };

    window.hideFilterModal = (event) => {
        if (event && event.target !== dom.filtersModal && !event.target.closest('.modal-content')) return;
         const content = document.querySelector('#more-filters-modal .modal-content');
        if (content) content.classList.remove('active');
        dom.filtersModal.classList.remove('active');
    };

    window.clearFilters = () => {
        filters = { ...initialFilters };
        document.getElementById("filter-league").value = 'All';
        document.getElementById("filter-prediction").value = 'All';
        document.getElementById("team-search-input").value = '';
        document.getElementById("filter-date").value = 'All Dates';
        document.getElementById("filter-home-odds").value = '';
        document.getElementById("main-filter-match-analysis").value = 'All';
        document.getElementById("main-filter-goals-analysis").value = 'All';
        applyFilters();
    };

    window.toggleFavorite = (uniqueId, fromModal = false) => {
        const matchIndex = favorites.findIndex(f => f.uniqueId === uniqueId);
        if (matchIndex > -1) {
            favorites.splice(matchIndex, 1);
        } else {
            const matchToAdd = allData.find(d => d.uniqueId === uniqueId);
            if (matchToAdd) favorites.push(matchToAdd);
        }
        localStorage.setItem('favorites', JSON.stringify(favorites.map(f => f.uniqueId)));
        if (fromModal) {
            const matchData = allData.find(d => d.uniqueId === uniqueId);
            if (matchData) showDetailsModal(matchData);
        }
        applyFilters();
    };
    
    document.addEventListener('DOMContentLoaded', async () => {
        dom.loading.classList.remove('hidden');
        try {
            const response = await fetch(CSV_URL);
            if (!response.ok) throw new Error('Network response was not ok');
            const csvText = await response.text();
            allData = parseCSV(csvText);

            const savedFavorites = JSON.parse(localStorage.getItem('favorites')) || [];
            favorites = allData.filter(item => savedFavorites.includes(item.uniqueId));

            buildAdvancedFiltersModal(); // Build modal after DOM is ready
            populateFilterDropdowns();
            populateUpcomingMatchesScroller();
            
            updateUiForTab();

        } catch (error) {
            console.error('Failed to load or parse data:', error);
            dom.mainContent.innerHTML = `<p class="text-center text-red-500">Error loading data. Please try again later.</p>`;
        } finally {
            dom.loading.classList.add('hidden');
        }
    });

    const populateFilterDropdowns = () => {
        const uniqueValues = (key) => [...new Set(allData.map(item => item[key]).filter(Boolean))].sort();
        const populate = (id, options, defaultLabel) => {
            const select = document.getElementById(id);
            if(select) {
              select.innerHTML = `<option>${defaultLabel}</option>${options.map(o => `<option>${o}</option>`).join('')}`;
            }
        };
        populate('filter-league', uniqueValues('League'), 'All');
        populate('filter-prediction', uniqueValues('Prediction'), 'All');
        populate('main-filter-match-analysis', uniqueValues('Match Analysis'), 'All');
        populate('main-filter-goals-analysis', uniqueValues('Goals Analysis'), 'All');

        const dateOptions = ['All Dates', ...[...new Set(allData.map(item => item['Match Date']))].sort((a,b) => {
            const dateA = new Date(a.split('/').reverse().join('-'));
            const dateB = new Date(b.split('/').reverse().join('-'));
            return dateB - dateA;
        })];
        const dateSelect = document.getElementById('filter-date');
        dateSelect.innerHTML = dateOptions.map(o => `<option>${o}</option>`).join('');
    };
    
    const populateUpcomingMatchesScroller = () => {
        const scroller = document.querySelector('#upcoming-matches-scroller .scroller-inner');
        const upcoming = allData.filter(m => {
            if (!m['Match Date']) return false;
            const parts = m['Match Date'].split('/');
            if (parts.length !== 3) return false;
            const [day, month, year] = parts;
            const matchDate = new Date(`${year}-${month}-${day}`);
            return matchDate >= new Date();
        }).slice(0, 20);

        const itemsHTML = upcoming.map(match => `
            <div class="flex-shrink-0 w-64 p-4 m-2 bg-white/10 rounded-lg text-white text-center interactive-scale transition-transform duration-300">
                <p class="text-xs font-semibold opacity-70">${match.League}</p>
                <p class="font-bold my-1">${match['Home Team']} vs ${match['Away Team']}</p>
                <p class="text-xs opacity-70">${match['Match Date']}</p>
                <p class="mt-2 text-sm font-bold bg-accent-green/20 text-accent-green py-1 px-3 rounded-full">${match.Prediction}</p>
            </div>
        `).join('');
        scroller.innerHTML = itemsHTML.repeat(2);
    };

    const renderDashboard = (data) => {
        const completed = data.filter(d => d.Outcome && d.Outcome !== 'N/A' && d.Outcome.trim() !== '');
        const totalCompleted = completed.length;
        const wins = completed.filter(d => getOutcomeColor(d.Prediction, d.Outcome)[2]).length;

        document.getElementById('stat-win-rate').textContent = totalCompleted > 0 ? `${((wins / totalCompleted) * 100).toFixed(1)}%` : '0%';
        document.getElementById('stat-accuracy').textContent = totalCompleted > 0 ? `${((wins / totalCompleted) * 100).toFixed(1)}%` : '0%';
        document.getElementById('stat-total-tips').textContent = data.length;
        
        const topTip = data.find(d => ["Best Home Tip", "Best Away Tip"].includes(d['Match Analysis']));
        document.getElementById('stat-top-tip').textContent = topTip ? topTip.Match : 'N/A';

        const outcomeCounts = completed.reduce((acc, d) => {
            const outcomeText = getOutcomeColor(d.Prediction, d.Outcome)[2] ? 'Win' : 'Loss';
            acc[outcomeText] = (acc[outcomeText] || 0) + 1;
            return acc;
        }, {});

        if (outcomeChart) outcomeChart.destroy();
        outcomeChart = new Chart(document.getElementById('outcome-pie-chart').getContext('2d'), {
            type: 'pie',
            data: {
                labels: Object.keys(outcomeCounts),
                datasets: [{ data: Object.values(outcomeCounts), backgroundColor: ['#10b981', '#ef4444'] }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        const predictionCounts = data.reduce((acc, d) => {
            acc[d.Prediction] = (acc[d.Prediction] || 0) + 1;
            return acc;
        }, {});

        if (predictionChart) predictionChart.destroy();
        predictionChart = new Chart(document.getElementById('prediction-bar-chart').getContext('2d'), {
            type: 'bar',
            data: {
                labels: Object.keys(predictionCounts),
                datasets: [{ label: 'Prediction Count', data: Object.values(predictionCounts), backgroundColor: '#0a0a2a' }]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
        });
    };

    window.downloadFavoritesPDF = () => {
        if (filteredFavorites.length === 0) {
            // Using a custom message box instead of alert
            showDetailsModal({Match: "No Favorites", League: "Please add some favorite matches before downloading."});
            return;
        }
        const doc = new jsPDF();
        doc.text("My Favorite Matches", 14, 16);
        doc.autoTable({
            startY: 20,
            head: [['Date', 'Match', 'Prediction', 'Outcome', 'Result']],
            body: filteredFavorites.map(fav => [
                fav['Match Date'],
                fav.Match,
                fav.Prediction,
                fav.Outcome,
                fav.Result
            ]),
        });
        doc.save('DataCompass360_Favorites.pdf');
    };

    const buildAdvancedFiltersModal = () => {
        // The modal is already in the HTML, we just need to ensure its logic is sound.
        // This function will create the content dynamically to keep the initial HTML clean.
        dom.filtersModal.innerHTML = `
            <div class="modal-content bg-white w-full max-w-4xl mx-4 p-6 rounded-2xl shadow-2xl relative" onclick="event.stopPropagation()">
                <button onclick="hideFilterModal(event)" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"></path></svg></button>
                <h3 class="text-2xl font-bold text-naviblue mb-6">Advanced Filters</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-semibold mb-2 text-gray-700">Team Streaks (Min)</h4>
                        <label class="block text-sm mb-1">Winning Streak</label>
                        <input type="number" id="adv-filter-win-streak" placeholder="e.g., 3" class="w-full p-2 border rounded-md">
                        <label class="block text-sm mt-3 mb-1">Losing Streak</label>
                        <input type="number" id="adv-filter-lose-streak" placeholder="e.g., 2" class="w-full p-2 border rounded-md">
                    </div>
                    <div>
                        <h4 class="font-semibold mb-2 text-gray-700">Odds Ranges</h4>
                        <div class="grid grid-cols-2 gap-2">
                            <div><label class="text-sm">Home Odds</label><input type="number" id="home-odds-min" placeholder="Min" class="w-full p-1 border rounded"><input type="number" id="home-odds-max" placeholder="Max" class="w-full p-1 border rounded mt-1"></div>
                            <div><label class="text-sm">Draw Odds</label><input type="number" id="draw-odds-min" placeholder="Min" class="w-full p-1 border rounded"><input type="number" id="draw-odds-max" placeholder="Max" class="w-full p-1 border rounded mt-1"></div>
                            <div class="col-span-2"><label class="text-sm">Away Odds</label><div class="grid grid-cols-2 gap-2"><input type="number" id="away-odds-min" placeholder="Min" class="w-full p-1 border rounded"><input type="number" id="away-odds-max" placeholder="Max" class="w-full p-1 border rounded"></div></div>
                        </div>
                    </div>
                </div>
                <div class="mt-8 text-right">
                    <button onclick="handleAdvancedFilterChange()" class="px-6 py-3 bg-accent-green text-white font-bold rounded-lg shadow-md hover:bg-green-600 transition">Apply Filters</button>
                </div>
            </div>`;
    };
    </script>
</body>
</html>
