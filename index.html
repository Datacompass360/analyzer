<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Sheet Data Manager</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configure Tailwind to include the specific Navy Blue and Accent Green colors
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'naviblue': '#000080', // Classic Navy Blue - Primary
                        'accent-green': '#10b981', // Emerald 500 equivalent - Accent
                    },
                    fontFamily: {
                        sans: ['Poppins', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <!-- Load Poppins font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600;700;800;900&display=swap');
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f7f7f7; /* Soft light background */
        }
        .scroll-container::-webkit-scrollbar {
            height: 8px;
        }
        .scroll-container::-webkit-scrollbar-thumb {
            background-color: #94a3b8; /* slate-400 */
            border-radius: 4px;
        }
        .scroll-container::-webkit-scrollbar-track {
            background-color: #e2e8f0; /* slate-200 */
        }
        /* Custom styling for the Upcoming Matches Scroller */
        .match-scroller {
            display: flex;
            overflow-x: auto;
            gap: 1rem;
            padding: 1rem 0;
            white-space: nowrap; /* Prevent items from wrapping */
            scroll-behavior: smooth;
        }
        .match-scroller::-webkit-scrollbar {
            display: none; /* Hide scrollbar for cleaner look */
        }
        .match-card {
            flex: 0 0 auto; /* Prevent cards from growing or shrinking */
            width: 280px;
            min-width: 280px;
            /* Dark background for contrast against Navy section background */
            background: rgba(255, 255, 255, 0.1); 
            color: white;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .match-card:hover {
            transform: translateY(-4px);
            background: rgba(255, 255, 255, 0.2); 
        }

        /* Styling for the modal backdrop */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            backdrop-filter: blur(4px);
        }
        .modal-content {
            max-height: 90vh; /* Limit height for responsiveness */
            overflow-y: auto;
        }
        
        /* Consistent Input Styling */
        .styled-input {
             @apply w-full p-3 border border-gray-300 rounded-xl shadow-sm focus:ring-4 focus:ring-accent-green/50 focus:border-accent-green transition duration-200;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">

        <!-- Header and Title - DataCompass 360 (NAVY BLUE) -->
        <header class="mb-8 p-6 bg-naviblue shadow-2xl rounded-2xl border-t-4 border-accent-green">
            <div class="flex items-center space-x-4">
                <!-- Icon/Feature: Compass/Data Point SVG (ACCENT GREEN) -->
                <div class="p-3 bg-accent-green/20 rounded-xl shadow-md">
                    <svg class="w-8 h-8 text-accent-green" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <!-- Compass structure -->
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm0 18a8 8 0 110-16 8 8 0 010 16zm-1-10.5h2V14h-2zm0-4h2V8h-2z"/>
                        <!-- North arrow -->
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0zM12 18V6"/>
                    </svg>
                </div>
                <!-- Title Text -->
                <div>
                    <h1 class="text-4xl font-extrabold text-white mb-1">
                        DataCompass 360
                    </h1>
                </div>
            </div>
        </header>

        <!-- Loading Indicator (ACCENT GREEN) -->
        <div id="loading-indicator" class="mb-6 p-4 bg-accent-green/10 border border-accent-green/30 text-sm font-medium text-naviblue rounded-lg flex items-center justify-center hidden">
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-accent-green inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Loading Data...
        </div>

        <!-- Dynamic Filters and Search Panel (WHITE) - ENHANCED STYLE -->
        <div class="mb-6 p-6 bg-white shadow-2xl rounded-2xl border-t-4 border-naviblue">
            
            <!-- Filter Header -->
            <h2 class="text-2xl font-extrabold text-naviblue mb-6 flex items-center border-b border-gray-200 pb-3">
                <svg class="w-6 h-6 mr-3 text-accent-green" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414A1 1 0 0012 15.586V21h-2v-5.414a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path></svg>
                Refine Your Data Insights
            </h2>
            
            <!-- Team Search -->
            <div class="mb-8">
                 <label for="team-search-input" class="block text-sm font-semibold text-gray-700 mb-2">Search Match or Team Name</label>
                 <input type="text" id="team-search-input" placeholder="e.g., Chelsea vs. Arsenal or just 'Chelsea'"
                        class="styled-input" oninput="handleTeamSearch()">
            </div>


            <!-- Dropdown Filters: League, Prediction, Date -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div>
                    <label for="filter-league" class="block text-sm font-semibold text-gray-700 mb-2">League</label>
                    <select id="filter-league" onchange="handleFilterChange()" class="styled-input">
                        <!-- Options populated dynamically -->
                    </select>
                </div>
                <div>
                    <label for="filter-prediction" class="block text-sm font-semibold text-gray-700 mb-2">Prediction Outcome</label>
                    <select id="filter-prediction" onchange="handleFilterChange()" class="styled-input">
                        <!-- Options populated dynamically -->
                    </select>
                </div>
                <div>
                    <label for="filter-matchDate" class="block text-sm font-semibold text-gray-700 mb-2">Match Date</label>
                    <select id="filter-matchDate" onchange="handleFilterChange()" class="styled-input">
                        <!-- Options populated dynamically -->
                    </select>
                </div>
            </div>

            <!-- Range Filters: Stakes and Streaks -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Stake Range Card -->
                <div class="p-4 border border-gray-200 rounded-xl bg-gray-50 shadow-inner">
                    <label class="block text-sm font-bold text-naviblue mb-3">Stake Range</label>
                    <div class="flex space-x-3">
                        <input type="number" id="filter-stake-min" placeholder="Min Stake" oninput="handleFilterChange()"
                               class="styled-input p-2 text-sm focus:ring-1 focus:ring-accent-green/50">
                        <input type="number" id="filter-stake-max" placeholder="Max Stake" oninput="handleFilterChange()"
                               class="styled-input p-2 text-sm focus:ring-1 focus:ring-accent-green/50">
                    </div>
                </div>

                <!-- Winning Streak Range Card -->
                <div class="p-4 border border-gray-200 rounded-xl bg-gray-50 shadow-inner">
                    <label class="block text-sm font-bold text-naviblue mb-3">Winning Streak Range</label>
                    <div class="flex space-x-3">
                        <input type="number" id="filter-wstreak-min" placeholder="Min Streak" oninput="handleFilterChange()"
                               class="styled-input p-2 text-sm focus:ring-1 focus:ring-accent-green/50">
                        <input type="number" id="filter-wstreak-max" placeholder="Max Streak" oninput="handleFilterChange()"
                               class="styled-input p-2 text-sm focus:ring-1 focus:ring-accent-green/50">
                    </div>
                </div>
                
                <!-- Losing Streak Range Card -->
                <div class="p-4 border border-gray-200 rounded-xl bg-gray-50 shadow-inner">
                    <label class="block text-sm font-bold text-naviblue mb-3">Losing Streak Range</label>
                    <div class="flex space-x-3">
                        <input type="number" id="filter-lstreak-min" placeholder="Min Streak" oninput="handleFilterChange()"
                               class="styled-input p-2 text-sm focus:ring-1 focus:ring-accent-green/50">
                        <input type="number" id="filter-lstreak-max" placeholder="Max Streak" oninput="handleFilterChange()"
                               class="styled-input p-2 text-sm focus:ring-1 focus:ring-accent-green/50">
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Table Container (WHITE) -->
        <div class="bg-white shadow-2xl rounded-2xl overflow-hidden ring-1 ring-gray-200 mb-8">
            <!-- Table Wrapper with horizontal scroll on small screens -->
            <div class="overflow-x-auto scroll-container">
                <table id="data-table" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100 sticky top-0 z-10 border-b-2 border-gray-300">
                        <tr>
                            <!-- Table headers will be injected here -->
                        </tr>
                    </thead>
                    <tbody id="table-body" class="bg-white divide-y divide-gray-100">
                        <!-- Table rows will be injected here -->
                    </tbody>
                </table>
            </div>

            <!-- Error/Empty State Message Box -->
            <div id="message-box" class="p-8 text-center hidden">
                <p class="text-lg font-semibold text-naviblue">No data available or error during fetch.</p>
                <p class="text-sm text-gray-400">Please check the console for details.</p>
            </div>
        </div>

        <!-- Pagination Controls (ACCENT GREEN) -->
        <div id="pagination-controls" class="mt-4 p-4 bg-white shadow-xl rounded-2xl flex justify-between items-center hidden">
            <button id="prev-button" onclick="handlePrevPage()"
                    class="px-4 py-2 text-sm font-medium rounded-full text-naviblue bg-accent-green/20 hover:bg-accent-green/30 disabled:opacity-50 transition duration-150 shadow-md">
                <span class="inline-flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    Previous
                </span>
            </button>
            <span id="page-status" class="text-sm font-medium text-gray-600"></span>
            <button id="next-button" onclick="handleNextPage()"
                    class="px-4 py-2 text-sm font-medium rounded-full text-naviblue bg-accent-green/20 hover:bg-accent-green/30 disabled:opacity-50 transition duration-150 shadow-md">
                 <span class="inline-flex items-center">
                    Next
                    <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                 </span>
            </button>
        </div>
        
        <!-- Upcoming Matches Scroller (NAVY BLUE) -->
        <div class="mt-8 p-6 bg-naviblue rounded-2xl shadow-2xl">
            <h2 class="text-2xl font-bold text-accent-green mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                Upcoming Matches (Next 30 Mins)
            </h2>
            <div id="upcoming-matches-scroller" class="match-scroller">
                <!-- Match cards will be injected here -->
            </div>
        </div>

    </div>

    <!-- Details Modal (Hidden by default) -->
    <div id="details-modal" class="modal-backdrop hidden" onclick="hideModal(event)">
        <div class="modal-content w-full max-w-4xl mx-4 bg-white rounded-3xl shadow-2xl transform transition-all duration-300" 
             onclick="event.stopPropagation()">
            
            <div class="p-6 md:p-8">
                <!-- Modal Header -->
                <div class="flex justify-between items-start mb-6 border-b pb-4">
                    <h3 id="modal-match-title" class="text-2xl md:text-3xl font-extrabold text-naviblue">Match Details</h3>
                    <button onclick="hideModal()" class="text-gray-400 hover:text-naviblue transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>

                <!-- Modal Content -->
                <div id="modal-content-stats" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Statistics will be dynamically injected here -->
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        // --- Configuration ---
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTqrL4iqD-lA0bQlJ_9zt0WaExOONsizhGyigkGsgHAGwCexf2b5p548fqUvCmET5GFAPSf6Ef74y7X/pub?gid=0&single=true&output=csv';

        // Columns required for the main table and the modal
        const COLUMN_MAP = [
            // Visible Table Columns
            { key: 'Match Date', label: 'Date', sortable: true, type: 'string' },
            { key: 'League', label: 'League', sortable: true, type: 'string' },
            { key: 'Match', label: 'Match', sortable: true, type: 'string' },
            { key: 'Home Odds', label: 'Home Odds', sortable: true, type: 'number' },
            { key: 'Draw Odds', label: 'Draw Odds', sortable: true, type: 'number' },
            { key: 'Away Odds', label: 'Away Odds', sortable: true, type: 'number' },
            { key: 'Correct Score', label: 'Score', sortable: true, type: 'string' },
            { key: 'Prediction', label: 'Prediction', sortable: true, type: 'string' },
            { key: 'Winning Streak', label: 'W Streak', sortable: true, type: 'number' },
            { key: 'Losing Streak', label: 'L Streak', sortable: true, type: 'number' },
            { key: 'Stake', label: 'Stake', sortable: true, type: 'number' },
            { key: 'Result', label: 'Result', sortable: true, type: 'string' },
            { key: 'Outcome', label: 'Outcome', sortable: true, type: 'string' },
            
            // Hidden Modal Columns (Must be parsed)
            { key: 'Home Team', label: 'Home Team', sortable: false, type: 'string' },
            { key: 'Away Team', label: 'Away Team', sortable: false, type: 'string' },
            { key: 'Home Wins', label: 'Home Wins', sortable: false, type: 'number' },
            { key: 'Home Losses', label: 'Home Losses', sortable: false, type: 'number' },
            { key: 'Away Wins', label: 'Away Wins', sortable: false, type: 'number' },
            { key: 'Away Draws', label: 'Away Draws', sortable: false, type: 'number' },
            { key: 'Away Losses', label: 'Away Losses', sortable: false, type: 'number' },
            { key: 'Home Team Scored', label: 'Home Team Scored', sortable: false, type: 'number' },
            { key: 'Home Avg Scored', label: 'Home Avg Scored', sortable: false, type: 'number' },
            { key: 'Home Conceded', label: 'Home Conceded', sortable: false, type: 'number' },
            { key: 'Home Avg Conceded', label: 'Home Avg Conceded', sortable: false, type: 'number' },
            { key: 'Away Team Scored', label: 'Away Team Scored', sortable: false, type: 'number' },
            { key: 'Away Avg Scored', label: 'Away Avg Scored', sortable: false, type: 'number' },
            { key: 'Away Conceded', label: 'Away Conceded', sortable: false, type: 'number' },
            { key: 'Away Avg Conceded', label: 'Away Avg Conceded', sortable: false, type: 'number' }
        ];

        // --- State Management ---
        let allData = [];      // Stores the original parsed data
        let currentData = [];  // Stores data after filtering/sorting (full set)
        let sortColumn = 'Match Date';
        let sortDirection = 'desc'; 
        let rowsPerPage = 30;
        let currentPage = 1;

        let filters = {
            league: 'All',
            prediction: 'All',
            matchDate: 'All',
            winningStreakMin: null,
            winningStreakMax: null,
            losingStreakMin: null,
            losingStreakMax: null,
            stakeMin: null,
            stakeMax: null,
            teamSearch: '',
        };

        // --- DOM Elements ---
        const tableBody = document.getElementById('table-body');
        const tableHeadRow = document.querySelector('#data-table thead tr');
        const loadingIndicator = document.getElementById('loading-indicator');
        const messageBox = document.getElementById('message-box');
        const paginationControls = document.getElementById('pagination-controls');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const pageStatus = document.getElementById('page-status');
        const detailsModal = document.getElementById('details-modal');
        const modalMatchTitle = document.getElementById('modal-match-title');
        const modalContentStats = document.getElementById('modal-content-stats');
        const upcomingScroller = document.getElementById('upcoming-matches-scroller');

        // --- Utility Functions (CSV Parsing, Filtering, Sorting) ---

        /**
         * Simple CSV parser that assumes the first row is headers. (Kept from previous version)
         */
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length === 0) return [];

            const rawHeaders = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const dataRows = lines.slice(1);
            const parsedData = [];

            const headerIndexMap = COLUMN_MAP.reduce((acc, col, requestedIndex) => {
                const csvIndex = rawHeaders.indexOf(col.key);
                if (csvIndex !== -1) {
                    acc[requestedIndex] = csvIndex;
                } else {
                    const csvIndexByLabel = rawHeaders.indexOf(col.label);
                    if (csvIndexByLabel !== -1) {
                         acc[requestedIndex] = csvIndexByLabel;
                    } else {
                        acc[requestedIndex] = requestedIndex;
                    }
                }
                return acc;
            }, {});


            dataRows.forEach(line => {
                if (!line.trim()) return;
                const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.trim().replace(/"/g, ''));
                
                const rowObject = {};
                COLUMN_MAP.forEach((col, requestedIndex) => {
                    const csvIndex = headerIndexMap[requestedIndex];
                    if (csvIndex !== undefined && values[csvIndex] !== undefined) {
                        let value = values[csvIndex];
                        if (col.type === 'number') {
                            rowObject[col.key] = isNaN(parseFloat(value)) ? null : parseFloat(value);
                        } else {
                            rowObject[col.key] = value;
                        }
                    } else {
                        rowObject[col.key] = ''; 
                    }
                });
                parsedData.push(rowObject);
            });

            return parsedData.filter(row => Object.values(row).some(v => v !== '' && v !== null));
        }

        function initializeFilters() {
            const getUniqueValues = (key) => {
                const values = allData.map(item => item[key]).filter(Boolean).map(String);
                return ['All', ...new Set(values)].sort();
            };

            const populateDropdown = (id, values) => {
                const select = document.getElementById(id);
                if (!select) return;

                select.innerHTML = '';
                values.forEach(value => {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = value;
                    select.appendChild(option);
                });
            };

            populateDropdown('filter-league', getUniqueValues('League'));
            populateDropdown('filter-prediction', getUniqueValues('Prediction'));
            populateDropdown('filter-matchDate', getUniqueValues('Match Date'));
            
            document.getElementById('filter-stake-min').value = '';
            document.getElementById('filter-stake-max').value = '';
            document.getElementById('filter-wstreak-min').value = '';
            document.getElementById('filter-wstreak-max').value = '';
            document.getElementById('filter-lstreak-min').value = '';
            document.getElementById('filter-lstreak-max').value = '';
            document.getElementById('team-search-input').value = '';
        }

        function renderTableHead() {
            const visibleColumns = COLUMN_MAP.filter(col => !['Home Team', 'Away Team', 'Home Wins', 'Home Losses', 'Away Wins', 'Away Draws', 'Away Losses', 'Home Team Scored', 'Home Avg Scored', 'Home Conceded', 'Home Avg Conceded', 'Away Team Scored', 'Away Avg Scored', 'Away Conceded', 'Away Avg Conceded'].includes(col.key));

            tableHeadRow.innerHTML = visibleColumns.map(col => {
                let icon = '';
                if (col.key === sortColumn) {
                    icon = sortDirection === 'asc' 
                        ? '<svg class="w-4 h-4 ml-2 text-accent-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>'
                        : '<svg class="w-4 h-4 ml-2 text-accent-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>';
                }
                
                return `
                    <th onclick="handleSort('${col.key}')" 
                        class="px-4 py-3 text-left text-xs font-extrabold text-gray-700 uppercase tracking-wider cursor-pointer hover:bg-gray-200 transition duration-150 whitespace-nowrap">
                        <div class="flex items-center">
                            ${col.label}
                            ${icon}
                        </div>
                    </th>
                `;
            }).join('');
        }
        
        // --- Enhanced Rendering for Rows ---
        function renderTableBody(dataSlice) {
            tableBody.innerHTML = '';
            
            if (currentData.length === 0) {
                messageBox.classList.remove('hidden');
                messageBox.querySelector('p:first-child').textContent = 'No results found matching your criteria.';
                return;
            } else {
                messageBox.classList.add('hidden');
            }

            const startIndex = (currentPage - 1) * rowsPerPage;

            const visibleColumnKeys = COLUMN_MAP
                .filter(col => !['Home Team', 'Away Team', 'Home Wins', 'Home Losses', 'Away Wins', 'Away Draws', 'Away Losses', 'Home Team Scored', 'Home Avg Scored', 'Home Conceded', 'Home Avg Conceded', 'Away Team Scored', 'Away Avg Scored', 'Away Conceded', 'Away Avg Conceded'].includes(col.key))
                .map(col => col.key);


            dataSlice.forEach((item, sliceIndex) => {
                const row = document.createElement('tr');
                // Navy/Green Theme Hover Effect
                const rowClass = sliceIndex % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                row.classList.add(rowClass, 'hover:bg-accent-green/10', 'transition', 'duration-150', 'cursor-pointer', 'border-b', 'border-gray-200');
                
                const dataIndex = startIndex + sliceIndex;
                row.onclick = () => showDetailsModal(dataIndex);


                visibleColumnKeys.forEach(key => {
                    const col = COLUMN_MAP.find(c => c.key === key);
                    const cell = document.createElement('td');
                    let content = (item[col.key] !== null && item[col.key] !== undefined) ? item[col.key].toString() : '';
                    cell.classList.add('px-4', 'py-3', 'whitespace-nowrap', 'text-sm');
                    
                    // Apply conditional styling for 'Outcome', 'Result', and numbers
                    if (col.key === 'Outcome') {
                        const isWin = content.toLowerCase() === 'win';
                        const bgColor = isWin ? 'bg-accent-green' : 'bg-red-600';
                        const textColor = 'text-white';
                        cell.innerHTML = `<span class="px-3 py-1 inline-flex text-xs leading-5 font-bold rounded-full ${bgColor} ${textColor} shadow-md">${content || 'N/A'}</span>`;
                        cell.classList.add('text-center');
                    } 
                    else if (col.key === 'Result') {
                        const lowerContent = content.toLowerCase();
                        const isHit = lowerContent.includes('hit');
                        const isMiss = lowerContent.includes('miss');
                        const isPending = lowerContent.includes('pending');
                        let bgColor = 'bg-gray-200';
                        let textColor = 'text-gray-800';
                        if (isHit) { bgColor = 'bg-accent-green'; textColor = 'text-white'; } // Green for Hit
                        if (isMiss) { bgColor = 'bg-red-500'; textColor = 'text-white'; } // Red for Miss
                        if (isPending) { bgColor = 'bg-yellow-500'; textColor = 'text-white'; } // Yellow for Pending

                        cell.innerHTML = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${bgColor} ${textColor}">${content || 'N/A'}</span>`;
                    }
                    else if (col.type === 'number') {
                        cell.classList.add('text-right', 'font-mono', 'text-naviblue', 'font-semibold'); // Navy text for numbers
                        if (col.key.includes('Odds') || col.key === 'Stake') {
                            cell.textContent = item[col.key] !== null ? item[col.key].toFixed(2) : 'N/A';
                        } else {
                            cell.textContent = content; 
                        }
                    }
                    else {
                         cell.classList.add('text-gray-900');
                         cell.textContent = content;
                    }

                    row.appendChild(cell);
                });
                tableBody.appendChild(row);
            });
        }
        
        function renderStatBlock(title, value, iconSvg, colorClass) {
            return `
                <div class="flex items-center space-x-4 p-4 bg-white rounded-xl shadow-lg transition duration-200 hover:shadow-xl hover:ring-2 hover:ring-${colorClass.replace('text-', '')}-500">
                    <div class="p-3 rounded-full ${colorClass.replace('text-', 'bg-')}-100">
                        <svg class="w-6 h-6 ${colorClass}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">${iconSvg}</svg>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-500 uppercase">${title}</p>
                        <p class="text-xl font-bold text-gray-900">${value}</p>
                    </div>
                </div>
            `;
        }

        window.showDetailsModal = function(dataIndex) {
            const item = currentData[dataIndex];
            if (!item) return;

            modalMatchTitle.textContent = `${item['Match']} (${item['League']})`;
            
            const formatNumber = (key, decimals = 2) => {
                const value = item[key];
                return value !== null && value !== undefined ? value.toFixed(decimals) : 'N/A';
            };

            const formatInteger = (key) => {
                 const value = item[key];
                 return value !== null && value !== undefined ? Math.round(value) : 'N/A';
            };

            // Customizing modal colors: Primary accent is Navy, secondary is Green/Red/Yellow
            const homeStats = `
                <div class="p-4 rounded-xl bg-naviblue/10 border-t-4 border-naviblue shadow-inner">
                    <h4 class="text-xl font-bold text-naviblue mb-4">${item['Home Team'] || 'Home Team'} (Home Stats)</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <!-- Home Wins (Green) -->
                        ${renderStatBlock('Home Wins', formatInteger('Home Wins'), '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.087 20.375l-.337.337m0 0l-7.5-7.5m7.5 7.5l7.5-7.5m-7.5 7.5l-.337.337m0 0l-7.5-7.5m7.5 7.5l7.5-7.5"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13.5l3 3 7-7"></path>', 'text-accent-green')}
                        <!-- Home Losses (Red) -->
                        ${renderStatBlock('Home Losses', formatInteger('Home Losses'), '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7 5V3H3v18h18z"></path>', 'text-red-500')}
                        
                        <!-- Home Scored (Navy/Blue) -->
                        ${renderStatBlock('Total Scored', formatInteger('Home Team Scored'), '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>', 'text-naviblue')}
                        <!-- Home Avg Scored (Navy/Blue) -->
                        ${renderStatBlock('Avg Scored', formatNumber('Home Avg Scored'), '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6m6 0h6m-6 0v-6m6 6v-6a2 2 0 00-2-2h-2a2 2 0 00-2 2v6m0 0H9m-9 0h24"></path>', 'text-naviblue')}
                        
                        <!-- Home Conceded (Yellow/Amber) -->
                        ${renderStatBlock('Total Conceded', formatInteger('Home Conceded'), '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11V3m0 0L8 7m4-4l4 4m-4 8v6m0 0l4-4m-4 4l-4-4"></path>', 'text-yellow-600')}
                        <!-- Home Avg Conceded (Yellow/Amber) -->
                        ${renderStatBlock('Avg Conceded', formatNumber('Home Avg Conceded'), '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m-3 0h24"></path>', 'text-yellow-600')}

                    </div>
                </div>
            `;

            const awayStats = `
                <div class="p-4 rounded-xl bg-accent-green/10 border-t-4 border-accent-green shadow-inner">
                    <h4 class="text-xl font-bold text-accent-green mb-4">${item['Away Team'] || 'Away Team'} (Away Stats)</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <!-- Away Wins (Green) -->
                        ${renderStatBlock('Away Wins', formatInteger('Away Wins'), '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.087 20.375l-.337.337m0 0l-7.5-7.5m7.5 7.5l7.5-7.5m-7.5 7.5l-.337.337m0 0l-7.5-7.5m7.5 7.5l7.5-7.5"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13.5l3 3 7-7"></path>', 'text-accent-green')}
                        <!-- Away Losses (Red) -->
                        ${renderStatBlock('Away Losses', formatInteger('Away Losses'), '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7 5V3H3v18h18z"></path>', 'text-red-500')}
                        
                        <!-- Away Scored (Navy/Blue) -->
                        ${renderStatBlock('Total Scored', formatInteger('Away Team Scored'), '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>', 'text-naviblue')}
                        <!-- Away Avg Scored (Navy/Blue) -->
                        ${renderStatBlock('Avg Scored', formatNumber('Away Avg Scored'), '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6m6 0h6m-6 0v-6m6 6v-6a2 2 0 00-2-2h-2a2 2 0 00-2 2v6m0 0H9m-9 0h24"></path>', 'text-naviblue')}
                        
                        <!-- Away Conceded (Yellow/Amber) -->
                        ${renderStatBlock('Total Conceded', formatInteger('Away Conceded'), '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11V3m0 0L8 7m4-4l4 4m-4 8v6m0 0l4-4m-4 4l-4-4"></path>', 'text-yellow-600')}
                        <!-- Away Avg Conceded (Yellow/Amber) -->
                        ${renderStatBlock('Avg Conceded', formatNumber('Away Avg Conceded'), '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m-3 0h24"></path>', 'text-yellow-600')}
                    </div>
                </div>
            `;

            const matchDetails = `
                <div class="lg:col-span-2 p-6 bg-gray-100 rounded-xl shadow-inner mt-4">
                    <h4 class="text-xl font-bold text-naviblue mb-4">Match & Prediction Summary</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        ${renderStatBlock('Prediction', item['Prediction'] || 'N/A', '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5h6"></path>', 'text-accent-green')}
                        ${renderStatBlock('Score', item['Correct Score'] || 'N/A', '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c1.657 0 3 .895 3 2s-1.343 2-3 2-3-.895-3-2 1.343-2 3-2zM21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.593 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>', 'text-accent-green')}
                        ${renderStatBlock('Stake', item['Stake'] !== null ? item['Stake'].toFixed(0) : 'N/A', '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>', 'text-naviblue')}
                        ${renderStatBlock('Result', item['Result'] || 'N/A', '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.24A9.95 9.95 0 0012 3C7.03 3 3 7.03 3 12s4.03 9 9 9 9-4.03 9-9c0-.49-.04-.97-.12-1.44"></path>', 'text-naviblue')}
                    </div>
                </div>
            `;

            modalContentStats.innerHTML = homeStats + awayStats + matchDetails;
            detailsModal.classList.remove('hidden');
        };

        window.hideModal = function(event) {
            if (event && event.target !== event.currentTarget) return; // Prevent closing if clicking inside modal content
            detailsModal.classList.add('hidden');
        };

        // --- Core Logic (Filtering, Sorting, Pagination) ---

        function applyFilters() {
            currentPage = 1; // Reset to first page on filter change
            let filtered = allData;

            // 1. Team Search Filter
            const search = filters.teamSearch.toLowerCase().trim();
            if (search) {
                filtered = filtered.filter(item => 
                    item['Match'].toLowerCase().includes(search) || 
                    item['Home Team'].toLowerCase().includes(search) || 
                    item['Away Team'].toLowerCase().includes(search)
                );
            }

            // 2. Dropdown Filters
            if (filters.league !== 'All') {
                filtered = filtered.filter(item => item['League'] === filters.league);
            }
            if (filters.prediction !== 'All') {
                filtered = filtered.filter(item => item['Prediction'] === filters.prediction);
            }
            if (filters.matchDate !== 'All') {
                filtered = filtered.filter(item => item['Match Date'] === filters.matchDate);
            }

            // 3. Range Filters (Stakes)
            if (filters.stakeMin !== null) {
                filtered = filtered.filter(item => item['Stake'] >= filters.stakeMin);
            }
            if (filters.stakeMax !== null) {
                filtered = filtered.filter(item => item['Stake'] <= filters.stakeMax);
            }
            
            // 4. Range Filters (Winning Streak)
            if (filters.winningStreakMin !== null) {
                filtered = filtered.filter(item => item['Winning Streak'] >= filters.winningStreakMin);
            }
            if (filters.winningStreakMax !== null) {
                filtered = filtered.filter(item => item['Winning Streak'] <= filters.winningStreakMax);
            }

            // 5. Range Filters (Losing Streak)
            if (filters.losingStreakMin !== null) {
                filtered = filtered.filter(item => item['Losing Streak'] >= filters.losingStreakMin);
            }
            if (filters.losingStreakMax !== null) {
                filtered = filtered.filter(item => item['Losing Streak'] <= filters.losingStreakMax);
            }

            currentData = filtered;
            applySort();
        }

        function applySort() {
            const column = COLUMN_MAP.find(col => col.key === sortColumn);
            if (!column) return;

            currentData.sort((a, b) => {
                const aVal = a[sortColumn];
                const bVal = b[sortColumn];

                if (column.type === 'number') {
                    const numA = aVal === null || aVal === undefined ? (sortDirection === 'asc' ? -Infinity : Infinity) : aVal;
                    const numB = bVal === null || bVal === undefined ? (sortDirection === 'asc' ? -Infinity : Infinity) : bVal;
                    return sortDirection === 'asc' ? numA - numB : numB - numA;
                } else {
                    const strA = String(aVal || '').toLowerCase();
                    const strB = String(bVal || '').toLowerCase();
                    if (strA < strB) return sortDirection === 'asc' ? -1 : 1;
                    if (strA > strB) return sortDirection === 'asc' ? 1 : -1;
                    return 0;
                }
            });

            renderTableHead(); // Update sort icon
            renderPage();
        }

        function renderPage() {
            const totalPages = Math.ceil(currentData.length / rowsPerPage);
            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const dataSlice = currentData.slice(start, end);

            renderTableBody(dataSlice);

            // Update Pagination UI
            if (currentData.length > rowsPerPage) {
                paginationControls.classList.remove('hidden');
            } else {
                paginationControls.classList.add('hidden');
            }

            prevButton.disabled = currentPage === 1;
            nextButton.disabled = currentPage === totalPages || currentData.length === 0;

            const startRange = currentData.length > 0 ? start + 1 : 0;
            const endRange = Math.min(end, currentData.length);
            pageStatus.textContent = `Showing ${startRange} to ${endRange} of ${currentData.length} entries`;
        }

        // --- Event Handlers ---

        window.handleSort = function(columnKey) {
            if (sortColumn === columnKey) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = columnKey;
                sortDirection = 'asc';
            }
            applySort();
        };

        window.handlePrevPage = function() {
            if (currentPage > 1) {
                currentPage--;
                renderPage();
            }
        };

        window.handleNextPage = function() {
            const totalPages = Math.ceil(currentData.length / rowsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderPage();
            }
        };

        window.handleFilterChange = function() {
            filters.league = document.getElementById('filter-league').value;
            filters.prediction = document.getElementById('filter-prediction').value;
            filters.matchDate = document.getElementById('filter-matchDate').value;
            
            filters.stakeMin = parseFloat(document.getElementById('filter-stake-min').value) || null;
            filters.stakeMax = parseFloat(document.getElementById('filter-stake-max').value) || null;
            filters.winningStreakMin = parseFloat(document.getElementById('filter-wstreak-min').value) || null;
            filters.winningStreakMax = parseFloat(document.getElementById('filter-wstreak-max').value) || null;
            filters.losingStreakMin = parseFloat(document.getElementById('filter-lstreak-min').value) || null;
            filters.losingStreakMax = parseFloat(document.getElementById('filter-lstreak-max').value) || null;

            applyFilters();
        };
        
        window.handleTeamSearch = function() {
            filters.teamSearch = document.getElementById('team-search-input').value;
            applyFilters();
        };

        // --- Upcoming Matches Logic ---

        function renderUpcomingMatches(data) {
            upcomingScroller.innerHTML = '';
            
            const now = new Date();
            // Filter for matches within the next 30 minutes that are 'Pending'
            const upcoming = data.filter(item => {
                if (item.Result && item.Result.toLowerCase() !== 'pending') return false;

                // Simple date parsing (assumes "MM/DD/YYYY HH:MM")
                const matchDate = new Date(item['Match Date']); 
                if (isNaN(matchDate)) return false;

                const diffMins = (matchDate - now) / (1000 * 60);
                // Check if the match is in the future but within the next 30 minutes
                return diffMins > 0 && diffMins <= 30; 
            }).slice(0, 5); // Limit to the top 5 closest matches

            if (upcoming.length === 0) {
                upcomingScroller.innerHTML = `<div class="p-4 text-white text-sm opacity-75">No matches pending within the next 30 minutes.</div>`;
                return;
            }

            upcoming.forEach(item => {
                // Determine the most predicted team/result for display
                const predictionText = item.Prediction ? `${item.Prediction}` : 'TBD';
                
                const card = document.createElement('div');
                card.className = 'match-card';
                card.innerHTML = `
                    <div class="flex justify-between items-center border-b border-gray-400 pb-2 mb-3">
                        <span class="text-xs font-semibold text-accent-green uppercase">${item.League}</span>
                        <span class="text-xs font-mono text-gray-300">${item['Match Date']}</span>
                    </div>
                    <p class="text-xl font-bold mb-3">${item['Home Team']} <span class="text-gray-400 font-normal text-base mx-1">vs</span> ${item['Away Team']}</p>
                    
                    <div class="mt-4 pt-3 border-t border-gray-400">
                        <p class="text-sm text-gray-400 mb-1">Our Prediction:</p>
                        <p class="text-lg font-extrabold text-accent-green">${predictionText}</p>
                    </div>
                    <div class="mt-3 grid grid-cols-3 gap-2 text-xs font-semibold text-center">
                        <div class="p-1 bg-white/20 rounded-md">1: ${formatNumber(item['Home Odds'])}</div>
                        <div class="p-1 bg-white/20 rounded-md">X: ${formatNumber(item['Draw Odds'])}</div>
                        <div class="p-1 bg-white/20 rounded-md">2: ${formatNumber(item['Away Odds'])}</div>
                    </div>
                `;
                upcomingScroller.appendChild(card);
            });
            
            function formatNumber(value) {
                return value !== null && value !== undefined ? value.toFixed(2) : 'N/A';
            }
        }

        // --- Initialization ---

        async function fetchData() {
            loadingIndicator.classList.remove('hidden');
            messageBox.classList.add('hidden');

            // Implement exponential backoff for robustness
            const maxRetries = 3;
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(CSV_URL);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const csvText = await response.text();
                    allData = parseCSV(csvText);
                    
                    // Initial setup
                    initializeFilters();
                    applyFilters(); // Filter and sort initially
                    renderUpcomingMatches(allData);

                    loadingIndicator.classList.add('hidden');
                    return; // Success
                } catch (error) {
                    console.error(`Attempt ${attempt + 1} failed to fetch data:`, error);
                    if (attempt === maxRetries - 1) {
                        loadingIndicator.classList.add('hidden');
                        messageBox.classList.remove('hidden');
                        messageBox.querySelector('p:first-child').textContent = 'Failed to load data after multiple attempts.';
                        console.error('Final attempt failed. Cannot load data.');
                        return;
                    }
                    // Wait with exponential backoff before retrying
                    const delay = Math.pow(2, attempt) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // Start application
        document.addEventListener('DOMContentLoaded', fetchData);
    </script>
</body>
</html>
