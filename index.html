<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataCompass 360 - Smart Football Insights</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js for Dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'naviblue': '#0a0a2a',
                        'accent-green': '#10b981',
                        'light-green-bg': '#f0fff4',
                        'popup-bg': '#e6f2ff', // Light blue
                        'popup-text': '#003366', // Dark navy
                    },
                    fontFamily: { sans: ['Poppins', 'sans-serif'] },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap');
        
        :root {
            --naviblue: #0a0a2a;
            --accent-green: #10b981;
            --glow-color: rgba(16, 185, 129, 0.7);
        }

        body { font-family: 'Poppins', sans-serif; background-color: #f0f2f5; }

        @keyframes glowing { 0%, 100% { box-shadow: 0 0 5px var(--glow-color), 0 0 10px var(--glow-color); } 50% { box-shadow: 0 0 20px var(--glow-color), 0 0 30px var(--glow-color); } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes twinkle {
            0% { box-shadow: 0 0 5px #34d399, 0 0 10px #34d399; }
            50% { box-shadow: 0 0 15px #6ee7b7, 0 0 25px #6ee7b7; }
            100% { box-shadow: 0 0 5px #34d399, 0 0 10px #34d399; }
        }

        .glassmorphic { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .pill-switcher { display: inline-flex; padding: 0.35rem; border-radius: 9999px; position: relative; }
        .pill-switcher button { transition: color 0.3s ease, transform 0.2s ease; z-index: 10; }
        .pill-switcher button.active-tab { color: white; transform: scale(1.05); text-shadow: 0 0 10px rgba(0,0,0,0.5); }
        .pill-switcher .glider { position: absolute; height: 100%; top: 0; left: 0; width: 25%; background-image: linear-gradient(to right, var(--accent-green), #059669); border-radius: 9999px; box-shadow: 0 4px 15px -3px rgba(16, 185, 129, 0.5); transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); z-index: 5; }
        
        .interactive-scale:hover { transform: translateY(-3px) scale(1.03); }
        
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(10, 10, 42, 0.8); backdrop-filter: blur(5px);
            display: flex; align-items: center; justify-content: center; z-index: 50;
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
        }
        .modal-backdrop.active { opacity: 1; pointer-events: auto; animation: fadeIn 0.3s ease forwards; }
        .modal-content { opacity: 0; }
        .modal-content.active { animation: slideUp 0.4s ease-out forwards; opacity: 1; }
        
        #data-table thead th, #favorites-table thead th { background-color: var(--naviblue) !important; color: white !important; font-weight: 800 !important; }
        #data-table tbody tr:hover, #favorites-table tbody tr:hover { background-image: linear-gradient(to right, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0)); transform: scale(1.01); transition: transform 0.2s ease; box-shadow: 0 4px 20px rgba(0,0,0,0.05); border-left: 4px solid var(--accent-green); cursor: pointer; }
        .viewed-row { background-color: #d1fae5 !important; } /* A slightly different green for viewed */
        
        .sort-icon { transition: transform 0.3s ease; }
        @keyframes scroll { from { transform: translateX(0); } to { transform: translateX(-100%); } }
        .scroller-inner { display: flex; flex-wrap: nowrap; width: fit-content; animation: scroll 60s linear infinite; }
        .match-scroller:hover .scroller-inner { animation-play-state: paused; }
        
        .star-icon { cursor: pointer; transition: transform 0.2s, color 0.2s; }
        .star-icon:hover { transform: scale(1.3); }
        .star-icon.favorited { color: #facc15; }

        .glow-win { animation: twinkle 2s infinite ease-in-out; }
    </style>
</head>
<body class="p-4 md:p-8 bg-gray-100">

    <div class="max-w-7xl mx-auto mb-6 flex justify-center">
        <div id="nav-container" class="pill-switcher glassmorphic">
            <span id="glider" class="glider"></span>
            <button id="tab-dashboard" onclick="handleTabClick('dashboard')" class="flex-1 py-3 px-6 rounded-full text-sm font-bold">Dashboard</button>
            <button id="tab-all" onclick="handleTabClick('all')" class="flex-1 py-3 px-6 rounded-full text-sm font-bold">All Matches</button>
            <button id="tab-best" onclick="handleTabClick('best')" class="flex-1 py-3 px-6 rounded-full text-sm font-bold">Best Tips</button>
            <button id="tab-favorites" onclick="handleTabClick('favorites')" class="flex-1 py-3 px-6 rounded-full text-sm font-bold">Favorites</button>
        </div>
    </div>

    <div class="max-w-7xl mx-auto">
        <header class="mb-8 p-8 bg-gradient-to-br from-naviblue via-indigo-900 to-black shadow-2xl rounded-2xl text-center overflow-hidden">
            <div class="inline-block p-4 bg-white/10 rounded-full" style="animation: glowing 3s infinite ease-in-out;"><svg class="w-12 h-12 text-accent-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm0 18a8 8 0 110-16 8 8 0 010 16z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12l-3-3m0 0l-3 3m3-3v12"></path></svg></div>
            <h1 class="text-4xl md:text-5xl font-extrabold text-white mt-4">DataCompass 360</h1>
            <p class="text-white/70 mt-2 text-sm md:text-base">Smart Football Insights Dashboard</p>
        </header>

        <div id="loading-indicator" class="mb-6 p-4 bg-accent-green/10 border border-accent-green/30 text-sm font-medium text-naviblue rounded-lg flex items-center justify-center hidden"><svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-accent-green" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></path><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Loading Data...</div>

        <div id="filters-panel" class="mb-6 p-6 bg-blue-100 shadow-xl rounded-2xl relative hidden">
             <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-extrabold text-gray-800 flex items-center"><svg class="w-6 h-6 mr-3 text-accent-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414A1 1 0 0012 15.586V21h-2v-5.414a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path></svg>Refine Insights</h2>
                <button onclick="clearFilters()" class="px-4 py-2 text-sm font-bold bg-red-500 text-white rounded-lg hover:bg-red-600 transition flex items-center"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>Clear Filters</button>
             </div>
             <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                 <div class="relative"><label class="block text-sm font-semibold text-gray-700 mb-2">Search</label><input type="text" id="team-search-input" placeholder="e.g., Chelsea" class="w-full p-3 border border-gray-300 rounded-xl shadow-sm" oninput="handleFilterChange()"></div>
                 <div class="relative"><label class="block text-sm font-semibold text-gray-700 mb-2">Match Date</label><select id="filter-date" onchange="handleFilterChange()" class="w-full p-3 border border-gray-300 rounded-xl shadow-sm"></select></div>
                 <div class="relative"><label class="block text-sm font-semibold text-gray-700 mb-2">League</label><select id="filter-league" onchange="handleFilterChange()" class="w-full p-3 border border-gray-300 rounded-xl shadow-sm"></select></div>
                 <div class="relative"><label class="block text-sm font-semibold text-gray-700 mb-2">Prediction</label><select id="filter-prediction" onchange="handleFilterChange()" class="w-full p-3 border border-gray-300 rounded-xl shadow-sm"></select></div>
                 <div class="relative"><label class="block text-sm font-semibold text-gray-700 mb-2">Home Odds (Min)</label><input type="number" id="filter-home-odds" placeholder="e.g., 1.5" class="w-full p-3 border border-gray-300 rounded-xl shadow-sm" oninput="handleFilterChange()"></div>
             </div>
             <button onclick="showFilterModal()" class="absolute -bottom-5 right-6 px-5 py-3 bg-accent-green text-white font-bold rounded-full shadow-lg hover:bg-accent-green/90 transition flex items-center" style="animation: glowing 3s infinite ease-in-out;"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 6V4m0 16v-2m8-6h2m-16 0H4m14.243-7.757l1.414-1.414M5.343 18.657l-1.414 1.414m14.142 0l-1.414-1.414M6.757 5.343l-1.414-1.414M12 18a6 6 0 100-12 6 6 0 000 12z"></path></svg>More Filters</button>
        </div>

        <div id="main-content" class="hidden">
            <div class="mt-12 p-1 bg-naviblue rounded-2xl shadow-2xl overflow-hidden">
                <div id="upcoming-matches-scroller" class="match-scroller"><div class="scroller-inner"></div></div>
            </div>
            <div id="table-container" class="bg-white shadow-2xl rounded-2xl overflow-hidden mt-12">
                <div class="overflow-x-auto"><table id="data-table" class="min-w-full"><thead class="sticky top-0 z-10"><tr></tr></thead><tbody id="table-body" class="divide-y divide-gray-100"></tbody></table></div>
                <div id="message-box" class="p-8 text-center hidden"><p class="text-lg font-semibold text-naviblue">No data found.</p></div>
            </div>
            <div id="pagination-controls" class="mt-6 flex justify-between items-center hidden"></div>
        </div>
        
        <div id="dashboard-content" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <div class="p-6 bg-white rounded-2xl shadow-lg"><h3 class="text-sm font-bold text-gray-500">WIN RATE</h3><p id="stat-win-rate" class="text-3xl font-extrabold text-accent-green mt-1">0%</p></div>
                <div class="p-6 bg-white rounded-2xl shadow-lg"><h3 class="text-sm font-bold text-gray-500">PREDICTION ACCURACY</h3><p id="stat-accuracy" class="text-3xl font-extrabold text-naviblue mt-1">0%</p></div>
                <div class="p-6 bg-white rounded-2xl shadow-lg"><h3 class="text-sm font-bold text-gray-500">TOTAL TIPS</h3><p id="stat-total-tips" class="text-3xl font-extrabold text-gray-700 mt-1">0</p></div>
                <div class="p-6 bg-white rounded-2xl shadow-lg"><h3 class="text-sm font-bold text-gray-500">TOP TIP</h3><p id="stat-top-tip" class="text-xl font-bold text-naviblue mt-1">N/A</p></div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="p-6 bg-white rounded-2xl shadow-lg"><h3 class="text-lg font-bold text-naviblue mb-4">Outcome Distribution</h3><canvas id="outcome-pie-chart"></canvas></div>
                <div class="p-6 bg-white rounded-2xl shadow-lg"><h3 class="text-lg font-bold text-naviblue mb-4">Prediction vs. Result</h3><canvas id="prediction-bar-chart"></canvas></div>
            </div>
        </div>

        <div id="favorites-content" class="hidden">
            <div class="bg-white shadow-2xl rounded-2xl overflow-hidden p-6">
                 <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-extrabold text-naviblue">⭐ Your Favorite Matches</h2>
                    <button id="download-pdf-btn" onclick="downloadFavoritesPDF()" class="px-4 py-2 text-sm font-bold bg-accent-green text-white rounded-lg hover:bg-green-600 transition flex items-center"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>Download PDF</button>
                </div>
                <div id="favorites-table-container" class="overflow-x-auto"></div>
            </div>
        </div>
    </div>
    
    <div id="details-modal" class="modal-backdrop hidden" onclick="hideDetailsModal(event)"></div>
    <div id="more-filters-modal" class="modal-backdrop hidden" onclick="hideFilterModal(event)"></div>

    <script type="text/javascript">
    const { jsPDF } = window.jspdf;
    // --- Configuration ---
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQH-Uue5Ctuo4aU-4S81U9QvoXxslOq6YjKHnVkPjyOeJqci4p19cs2iZ8y5GgzsSh_vQHxPYb-gl-5/pub?gid=0&single=true&output=csv';
    const HIDDEN_COLUMNS = ['Home Team', 'Away Team', 'Home Wins', 'Home Draws', 'Home Losses', 'Away Wins', 'Away Draws', 'Away Losses', 'Home Team Scored', 'Home Avg Scored', 'Home Conceded', 'Home Avg Conceded', 'Away Team Scored', 'Away Avg Scored', 'Away Conceded', 'Away Avg Conceded', 'Match Analysis', 'Goals Analysis'];
    const COLUMN_MAP = [
        { key: 'Match Date', label: 'Date' }, { key: 'League', label: 'League' }, { key: 'Match', label: 'Match' }, { key: 'Prediction', label: 'Prediction' }, { key: 'Outcome', label: 'Outcome' }, { key: 'Correct Score', label: 'Score' }, { key: 'Home Odds', label: '1' }, { key: 'Draw Odds', label: 'X' }, { key: 'Away Odds', label: '2' }, { key: 'Home Team', type: 'string' }, { key: 'Away Team', type: 'string' }, { key: 'Result', type: 'string' }, { key: 'Winning Streak', type: 'number' }, { key: 'Losing Streak', type: 'number' }, { key: 'Stake', type: 'number' }, { key: 'Home Wins', type: 'number' }, { key: 'Home Draws', type: 'number' }, { key: 'Home Losses', type: 'number' }, { key: 'Away Wins', type: 'number' }, { key: 'Away Draws', type: 'number' }, { key: 'Away Losses', type: 'number' }, { key: 'Home Team Scored', type: 'number' }, { key: 'Home Avg Scored', type: 'number' }, { key: 'Home Conceded', type: 'number' }, { key: 'Home Avg Conceded', type: 'number' }, { key: 'Away Team Scored', type: 'number' }, { key: 'Away Avg Scored', type: 'number' }, { key: 'Away Conceded', type: 'number' }, { key: 'Away Avg Conceded', type: 'number' }, { key: 'Match Analysis', type: 'string' }, { key: 'Goals Analysis', type: 'string' }
    ];

    let allData = [], currentData = [], favorites = [], viewedRows = new Set(), outcomeChart, predictionChart, filteredFavorites = [];
    let sortColumn = 'Match Date', sortDirection = 'desc', rowsPerPage = 30, currentPage = 1, activeTab = 'dashboard';
    const initialFilters = { 
        league: 'All', prediction: 'All', teamSearch: '', matchAnalysis: 'All', goalsAnalysis: 'All',
        matchDate: 'All Dates', homeOddsMin: null,
        winningStreak: null, losingStreak: null,
        homeOddsAdvancedMin: null, homeOddsAdvancedMax: null,
        drawOddsMin: null, drawOddsMax: null,
        awayOddsMin: null, awayOddsMax: null
    };
    let filters = { ...initialFilters };

    const dom = {
        loading: document.getElementById('loading-indicator'),
        mainContent: document.getElementById('main-content'),
        dashboardContent: document.getElementById('dashboard-content'),
        favoritesContent: document.getElementById('favorites-content'),
        tableBody: document.getElementById('table-body'),
        tableHeadRow: document.querySelector('#data-table thead tr'),
        messageBox: document.getElementById('message-box'),
        pagination: document.getElementById('pagination-controls'),
        glider: document.getElementById('glider'),
        detailsModal: document.getElementById('details-modal'),
        filtersModal: document.getElementById('more-filters-modal'),
        filtersPanel: document.getElementById('filters-panel')
    };

    const icons = {
        win: '🏆', draw: '🤝', loss: '❌', goal: '⚽', average: '📊', analysis: '🔍', streak: '🔥'
    };

    const parseCSV = (csvText) => {
        const lines = csvText.trim().split("\n");
        const headers = lines[0].split(",").map(h => h.trim().replace(/"/g, ""));
        return lines.slice(1).map(line => {
            if (!line.trim()) return null;
            const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.trim().replace(/"/g, ''));
            const rowObject = {};
            COLUMN_MAP.forEach(col => {
                const index = headers.indexOf(col.key);
                if (index !== -1 && values[index] !== undefined) {
                    rowObject[col.key] = col.type === 'number' ? (isNaN(parseFloat(values[index])) ? null : parseFloat(values[index])) : values[index];
                } else {
                    rowObject[col.key] = col.type === 'number' ? null : "";
                }
            });
            return rowObject;
        }).filter(row => row && row.Match);
    };

    const applyFilters = () => {
        currentPage = 1;
        let sourceData = (activeTab === 'favorites') ? favorites : allData;
        let filteredData = sourceData;

        if (activeTab === 'best') {
            const bestTipsValues = ["Best Away Tip", "Best Home Tip", "Home Tip", "Good Away Tip", "Home Good Tip", "Away Tip"];
            filteredData = filteredData.filter(item => bestTipsValues.includes(item["Match Analysis"]));
        }

        const searchTerm = filters.teamSearch.toLowerCase().trim();
        if (searchTerm) filteredData = filteredData.filter(item => item.Match.toLowerCase().includes(searchTerm));
        if (filters.league !== 'All') filteredData = filteredData.filter(item => item.League === filters.league);
        if (filters.prediction !== 'All') filteredData = filteredData.filter(item => item.Prediction === filters.prediction);
        if (filters.matchDate !== 'All Dates') filteredData = filteredData.filter(item => item['Match Date'] === filters.matchDate);
        if (filters.homeOddsMin) filteredData = filteredData.filter(item => item['Home Odds'] >= filters.homeOddsMin);
        if (filters.winningStreak) filteredData = filteredData.filter(item => (item['Winning Streak'] || 0) >= filters.winningStreak);
        if (filters.losingStreak) filteredData = filteredData.filter(item => (item['Losing Streak'] || 0) >= filters.losingStreak);
        if (filters.matchAnalysis !== 'All') filteredData = filteredData.filter(item => item['Match Analysis'] === filters.matchAnalysis);
        if (filters.goalsAnalysis !== 'All') filteredData = filteredData.filter(item => item['Goals Analysis'] === filters.goalsAnalysis);
        
        const oddsFilters = [
            { key: 'Home Odds', min: filters.homeOddsAdvancedMin, max: filters.homeOddsAdvancedMax },
            { key: 'Draw Odds', min: filters.drawOddsMin, max: filters.drawOddsMax },
            { key: 'Away Odds', min: filters.awayOddsMin, max: filters.awayOddsMax },
        ];
        oddsFilters.forEach(f => {
            if (f.min) filteredData = filteredData.filter(item => item[f.key] >= f.min);
            if (f.max) filteredData = filteredData.filter(item => item[f.key] <= f.max);
        });

        if (activeTab === 'dashboard') renderDashboard(filteredData);
        else if (activeTab === 'favorites') { filteredFavorites = filteredData; renderFavorites(); }
        else { currentData = filteredData; applySort(); }
    };

    const applySort = () => {
        currentData.sort((a, b) => {
            const valA = a[sortColumn], valB = b[sortColumn];
            if (typeof valA === 'number') return sortDirection === 'asc' ? (valA || 0) - (valB || 0) : (valB || 0) - (valA || 0);
            return sortDirection === 'asc' ? String(valA || "").localeCompare(String(valB || "")) : String(valB || "").localeCompare(String(valA || ""));
        });
        renderTableHead();
        renderPage();
    };

    const renderTableHead = () => {
        const visibleCols = COLUMN_MAP.filter(c => c.label && !HIDDEN_COLUMNS.includes(c.key));
        dom.tableHeadRow.innerHTML = `<th></th>` + visibleCols.map(col => `<th onclick="handleSort('${col.key}')" class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider cursor-pointer"><div class="flex items-center">${col.label}${col.key === sortColumn ? `<svg class="w-4 h-4 ml-2 sort-icon ${sortDirection === 'desc' ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5 15l7-7 7 7"></path></svg>` : ''}</div></th>`).join("") + `<th>Actions</th>`;
    };

    const renderPage = () => {
        const totalPages = Math.ceil(currentData.length / rowsPerPage);
        const start = (currentPage - 1) * rowsPerPage;
        renderTableBody(currentData.slice(start, start + rowsPerPage));
        dom.pagination.innerHTML = currentData.length > rowsPerPage ? `<button onclick="handlePrevPage()" class="px-4 py-2 text-sm font-medium rounded-full bg-white shadow" ${currentPage === 1 ? 'disabled' : ''}>Prev</button><span class="text-sm font-semibold">Page ${currentPage} of ${totalPages}</span><button onclick="handleNextPage()" class="px-4 py-2 text-sm font-medium rounded-full bg-white shadow" ${currentPage === totalPages || totalPages === 0 ? 'disabled' : ''}>Next</button>` : "";
        dom.pagination.classList.toggle('hidden', currentData.length <= rowsPerPage);
    };

    const renderTableBody = (data) => {
        dom.tableBody.innerHTML = "";
        if (data.length === 0) {
            dom.messageBox.classList.remove("hidden");
            dom.messageBox.querySelector("p").textContent = "No results match your criteria.";
            return;
        }
        dom.messageBox.classList.add("hidden");
        const visibleCols = COLUMN_MAP.filter(c => c.label && !HIDDEN_COLUMNS.includes(c.key));
        data.forEach(item => {
            const row = document.createElement("tr");
            const itemJSON = encodeURIComponent(JSON.stringify(item));
            row.className = `transition-all duration-200 ${viewedRows.has(item.Match) ? "viewed-row" : ""}`;
            row.ondblclick = () => handleRowClick(item);

            let rowHTML = `<td class="px-2 py-3 text-center"><span onclick="event.stopPropagation(); toggleFavorite('${item.Match}')" class="star-icon text-2xl ${favorites.some(f => f.Match === item.Match) ? "favorited" : ""}">${favorites.some(f => f.Match === item.Match) ? '⭐' : '☆'}</span></td>`;
            visibleCols.forEach(col => {
                const value = item[col.key] || "N/A";
                if (col.key === 'Outcome') {
                    const [bgColor, text, isWin] = getOutcomeColor(item.Prediction, value);
                    rowHTML += `<td class="px-4 py-3 whitespace-nowrap text-sm"><span class="px-3 py-1 text-xs font-bold rounded-full text-white ${bgColor} shadow-md ${isWin ? 'glow-win' : ''}">${text}</span></td>`;
                } else {
                    rowHTML += `<td class="px-4 py-3 whitespace-nowrap text-sm">${value}</td>`;
                }
            });
            
            rowHTML += `<td class="px-4 py-3"><button onclick="event.stopPropagation(); showDetailsModal(JSON.parse(decodeURIComponent('${itemJSON}')))" class="px-3 py-1 text-xs font-bold bg-blue-500 text-white rounded-full hover:bg-blue-600">View</button></td>`;
            row.innerHTML = rowHTML;
            dom.tableBody.appendChild(row);
        });
    };
    
    const getOutcomeColor = (prediction, outcome) => {
        if (!prediction || !outcome || outcome === "N/A") return ["bg-gray-400", outcome, false];
        const p = prediction.toLowerCase(), o = outcome.toLowerCase();
        if ((p.includes("home") && o.includes("home")) || (p.includes("away") && o.includes("away")) || (p.includes("draw") && o.includes("draw"))) {
            return ["bg-accent-green", outcome, true];
        }
        return ["bg-red-500", outcome, false];
    };

    const handleRowClick = (item) => {
        viewedRows.add(item.Match);
        showDetailsModal(item);
        if (['all', 'best'].includes(activeTab)) renderPage();
    };
    window.handleSort = (key) => { sortColumn === key ? sortDirection = (sortDirection === 'asc' ? 'desc' : 'asc') : (sortColumn = key, sortDirection = 'asc'); applySort(); };
    window.handleTabClick = (tab) => { activeTab = tab; updateUiForTab(); };
    window.handleFilterChange = () => {
        filters.league = document.getElementById("filter-league").value; 
        filters.prediction = document.getElementById("filter-prediction").value; 
        filters.teamSearch = document.getElementById("team-search-input").value;
        filters.matchDate = document.getElementById("filter-date").value;
        filters.homeOddsMin = parseFloat(document.getElementById("filter-home-odds").value) || null;
        applyFilters(); 
    };
    window.handleAdvancedFilterChange = () => {
        filters.matchAnalysis = document.getElementById("filter-match-analysis").value;
        filters.goalsAnalysis = document.getElementById("filter-goals-analysis").value;
        filters.winningStreak = parseFloat(document.getElementById("adv-filter-win-streak").value) || null;
        filters.losingStreak = parseFloat(document.getElementById("adv-filter-lose-streak").value) || null;
        filters.homeOddsAdvancedMin = parseFloat(document.getElementById("home-odds-min").value) || null;
        filters.homeOddsAdvancedMax = parseFloat(document.getElementById("home-odds-max").value) || null;
        filters.drawOddsMin = parseFloat(document.getElementById("draw-odds-min").value) || null;
        filters.drawOddsMax = parseFloat(document.getElementById("draw-odds-max").value) || null;
        filters.awayOddsMin = parseFloat(document.getElementById("away-odds-min").value) || null;
        filters.awayOddsMax = parseFloat(document.getElementById("away-odds-max").value) || null;
        hideFilterModal();
        applyFilters();
    };
    window.handlePrevPage = () => { if (currentPage > 1) { currentPage--; renderPage(); } };
    window.handleNextPage = () => { if (currentPage < Math.ceil(currentData.length / rowsPerPage)) { currentPage++; renderPage(); } };

    const updateUiForTab = () => {
        const tabPositions = { dashboard: 0, all: 1, best: 2, favorites: 3 };
        dom.glider.style.transform = `translateX(${100 * tabPositions[activeTab]}%)`;
        Object.keys(tabPositions).forEach(t => document.getElementById(`tab-${t}`).classList.toggle("active-tab", t === activeTab));
        const isDashboard = activeTab === 'dashboard', isFavorites = activeTab === 'favorites';
        dom.dashboardContent.classList.toggle('hidden', !isDashboard);
        dom.favoritesContent.classList.toggle('hidden', !isFavorites);
        dom.mainContent.classList.toggle('hidden', isDashboard || isFavorites);
        dom.filtersPanel.classList.toggle('hidden', false);
        applyFilters();
    };
    
    window.showDetailsModal = (item) => {
        const isFavorited = favorites.some(f => f.Match === item.Match);
        const formatInt = (val) => val !== null ? Math.round(val) : "N/A";
        const formatAvg = (val) => val !== null ? val.toFixed(2) : "N/A";

        const statRow = (icon, homeVal, awayVal) => `
            <div class="grid grid-cols-11 gap-2 text-sm items-center py-2">
                <div class="col-span-5 text-right font-semibold">${homeVal}</div>
                <div class="col-span-1 text-center text-xl">${icon}</div>
                <div class="col-span-5 text-left font-semibold">${awayVal}</div>
            </div>`;

        const analysisRow = (icon, homeVal, awayVal) => `
            <div class="grid grid-cols-11 gap-2 text-sm items-start py-2">
                <div class="col-span-5 text-right font-semibold">${homeVal}</div>
                <div class="col-span-1 text-center text-xl pt-1">${icon}</div>
                <div class="col-span-5 text-left font-semibold">${awayVal}</div>
            </div>`;

        const itemJSON = encodeURIComponent(JSON.stringify(item));
        dom.detailsModal.innerHTML = `
            <div class="modal-content bg-popup-bg w-full max-w-3xl mx-4 rounded-2xl shadow-2xl text-popup-text relative">
                <button onclick="hideDetailsModal()" class="absolute top-3 right-3 text-popup-text/50 hover:text-popup-text hover:bg-black/10 rounded-full p-2 transition z-10">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
                <div class="p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-grow">
                             <h3 class="text-2xl font-extrabold text-center">${item.Match}</h3>
                             <p class="text-center text-sm font-medium text-popup-text/80">${item.League}</p>
                        </div>
                        <button onclick="toggleFavorite(JSON.parse(decodeURIComponent('${itemJSON}')), true)" class="text-3xl transition-transform duration-200 hover:scale-125 -mt-1 ml-4">${isFavorited ? '⭐' : '☆'}</button>
                    </div>
                    
                    <div class="bg-white/50 p-4 rounded-lg">
                        <div class="grid grid-cols-11 gap-2 text-sm font-bold text-popup-text/80 mb-2 border-b-2 border-popup-text/10 pb-2">
                            <div class="col-span-5 text-right">${item['Home Team']}</div>
                            <div class="col-span-1 text-center"></div>
                            <div class="col-span-5 text-left">${item['Away Team']}</div>
                        </div>
                        <div class="divide-y divide-popup-text/10">
                            ${statRow(icons.win, formatInt(item['Home Wins']), formatInt(item['Away Wins']))}
                            ${statRow(icons.draw, formatInt(item['Home Draws']), formatInt(item['Away Draws']))}
                            ${statRow(icons.loss, formatInt(item['Home Losses']), formatInt(item['Away Losses']))}
                            ${statRow(icons.goal, formatInt(item['Home Team Scored']), formatInt(item['Away Team Scored']))}
                            ${statRow(icons.average, formatAvg(item['Home Avg Scored']), formatAvg(item['Away Avg Scored']))}
                            ${statRow(icons.average, formatInt(item['Home Conceded']), formatInt(item['Away Conceded']))}
                            ${statRow(icons.average, formatAvg(item['Home Avg Conceded']), formatAvg(item['Away Avg Conceded']))}
                            ${analysisRow(icons.streak, `Win Streak: ${formatInt(item['Winning Streak'])}`, item['Match Analysis'] || 'N/A')}
                            ${analysisRow(icons.streak, `Loss Streak: ${formatInt(item['Losing Streak'])}`, item['Goals Analysis'] || 'N/A')}
                        </div>
                    </div>
                </div>
            </div>`;
        dom.detailsModal.classList.remove("hidden");
        requestAnimationFrame(() => { dom.detailsModal.classList.add("active"); dom.detailsModal.querySelector(".modal-content").classList.add("active"); });
    };

    window.hideDetailsModal = (event) => {
        // This now works for the button too, as event will be undefined.
        if(event && event.currentTarget !== event.target) return;
        dom.detailsModal.classList.remove("active");
        if(dom.detailsModal.querySelector(".modal-content")) dom.detailsModal.querySelector(".modal-content").classList.remove("active");
        setTimeout(() => dom.detailsModal.classList.add("hidden"), 300);
    };

    window.showFilterModal = () => {
        dom.filtersModal.innerHTML = `<div class="modal-content bg-blue-100 border border-accent-green/20 w-full max-w-4xl mx-4 rounded-3xl shadow-2xl text-gray-800"><button onclick="hideFilterModal(event)" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 rounded-full p-2"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"></path></svg></button><div class="p-6 md:p-8"><h3 class="text-2xl font-extrabold text-gray-800 text-center mb-6">Advanced Filters</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="p-4 bg-white/60 rounded-xl space-y-4">
                    <div><label class="block text-sm font-semibold mb-2">Match Analysis</label><select id="filter-match-analysis" class="w-full p-3 border border-gray-300 rounded-xl shadow-sm"></select></div>
                    <div><label class="block text-sm font-semibold mb-2">Goals Analysis</label><select id="filter-goals-analysis" class="w-full p-3 border border-gray-300 rounded-xl shadow-sm"></select></div>
                    <div class="grid grid-cols-2 gap-2">
                        <div><label class="block text-sm font-semibold mb-2">Min Win Streak</label><input type="number" id="adv-filter-win-streak" placeholder="e.g., 3" class="w-full p-3 border rounded-lg" value="${filters.winningStreak || ''}"></div>
                        <div><label class="block text-sm font-semibold mb-2">Min Lose Streak</label><input type="number" id="adv-filter-lose-streak" placeholder="e.g., 2" class="w-full p-3 border rounded-lg" value="${filters.losingStreak || ''}"></div>
                    </div>
                </div>
                <div class="p-4 bg-white/60 rounded-xl space-y-4">
                    <div class="grid grid-cols-2 gap-x-4 items-center"><label class="font-semibold">Home Odds</label><div class="grid grid-cols-2 gap-2"><input type="number" id="home-odds-min" placeholder="Min" class="w-full p-2 border rounded-lg" value="${filters.homeOddsAdvancedMin || ''}"><input type="number" id="home-odds-max" placeholder="Max" class="w-full p-2 border rounded-lg" value="${filters.homeOddsAdvancedMax || ''}"></div></div>
                    <div class="grid grid-cols-2 gap-x-4 items-center"><label class="font-semibold">Draw Odds</label><div class="grid grid-cols-2 gap-2"><input type="number" id="draw-odds-min" placeholder="Min" class="w-full p-2 border rounded-lg" value="${filters.drawOddsMin || ''}"><input type="number" id="draw-odds-max" placeholder="Max" class="w-full p-2 border rounded-lg" value="${filters.drawOddsMax || ''}"></div></div>
                    <div class="grid grid-cols-2 gap-x-4 items-center"><label class="font-semibold">Away Odds</label><div class="grid grid-cols-2 gap-2"><input type="number" id="away-odds-min" placeholder="Min" class="w-full p-2 border rounded-lg" value="${filters.awayOddsMin || ''}"><input type="number" id="away-odds-max" placeholder="Max" class="w-full p-2 border rounded-lg" value="${filters.awayOddsMax || ''}"></div></div>
                </div>
            </div>
            <div class="mt-8 pt-6 border-t border-gray-300 flex justify-end space-x-4"><button onclick="hideFilterModal(event)" class="px-6 py-2 text-sm font-bold bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button><button onclick="handleAdvancedFilterChange()" class="px-6 py-2 text-sm font-bold text-white bg-accent-green rounded-lg hover:bg-green-500">Apply</button></div></div></div>`;
        dom.filtersModal.classList.remove("hidden");
        requestAnimationFrame(() => { dom.filtersModal.classList.add("active"); dom.filtersModal.querySelector(".modal-content").classList.add("active"); });
        const matchAnalysisOptions = ["All", ...new Set(allData.map(item => item["Match Analysis"]).filter(Boolean))].sort();
        document.getElementById("filter-match-analysis").innerHTML = matchAnalysisOptions.map(opt => `<option value="${opt}" ${filters.matchAnalysis === opt ? 'selected' : ''}>${opt}</option>`).join('');
        const goalsAnalysisOptions = ["All", ...new Set(allData.map(item => item["Goals Analysis"]).filter(Boolean))].sort();
        document.getElementById("filter-goals-analysis").innerHTML = goalsAnalysisOptions.map(opt => `<option value="${opt}" ${filters.goalsAnalysis === opt ? 'selected' : ''}>${opt}</option>`).join('');
    };
    window.hideFilterModal = (event) => {
        if(event && event.currentTarget !== event.target) return;
        dom.filtersModal.classList.remove("active");
        if(dom.filtersModal.querySelector(".modal-content")) dom.filtersModal.querySelector(".modal-content").classList.remove("active");
        setTimeout(() => dom.filtersModal.classList.add("hidden"), 300);
    };
    
    const renderFavorites = () => {
        const container = document.getElementById('favorites-table-container');
        document.getElementById('download-pdf-btn').disabled = filteredFavorites.length === 0;
        if (filteredFavorites.length === 0) {
            container.innerHTML = '<p class="text-center text-gray-500 py-8">No favorites match the current filters. Clear filters to see all your favorites.</p>';
            return;
        }
        const visibleCols = COLUMN_MAP.filter(c => ['Match Date', 'League', 'Match', 'Prediction', 'Outcome'].includes(c.key));
        container.innerHTML = `<table id="favorites-table" class="min-w-full">
            <thead class="sticky top-0 z-10"><tr>${visibleCols.map(c => `<th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">${c.label}</th>`).join('')}<th></th></tr></thead>
            <tbody class="divide-y divide-gray-100">${filteredFavorites.map(item => `<tr ondblclick="showDetailsModal(JSON.parse(decodeURIComponent('${encodeURIComponent(JSON.stringify(item))}')))">${visibleCols.map(c => `<td class="px-4 py-3 whitespace-nowrap text-sm">${item[c.key] || 'N/A'}</td>`).join('')}<td class="px-4 py-3 text-center"><button onclick="event.stopPropagation(); removeFromFavorites('${item.Match}')" class="text-red-500 hover:text-red-700 font-bold p-2 rounded-full text-xl leading-none">&times;</button></td></tr>`).join('')}</tbody>
        </table>`;
    };

    window.toggleFavorite = (item, fromPopup = false) => {
        const matchId = item.Match;
        const matchIndex = favorites.findIndex(f => f.Match === matchId);
        if (matchIndex > -1) favorites.splice(matchIndex, 1);
        else favorites.push(item);
        
        localStorage.setItem('favorites', JSON.stringify(favorites));

        if (fromPopup) {
            showDetailsModal(item); // Re-render the popup to update the star
        }

        if (activeTab === 'favorites') {
             applyFilters();
        } else if (['all', 'best'].includes(activeTab)) {
            renderPage();
        }
    };


    window.removeFromFavorites = (matchId) => {
        favorites = favorites.filter(f => f.Match !== matchId);
        localStorage.setItem('favorites', JSON.stringify(favorites));
        applyFilters();
        if (['all', 'best'].includes(activeTab)) renderPage();
    };

    const downloadFavoritesPDF = () => {
        const doc = new jsPDF();
        const head = [['Date', 'League', 'Match', 'Prediction', 'Outcome']];
        const body = filteredFavorites.map(item => [item['Match Date'], item.League, item.Match, item.Prediction, item.Outcome || 'N/A']);
        
        doc.setFontSize(18);
        doc.text("Favorite Matches Report", 14, 22);
        
        let filterText = "Applied Filters:\n";
        let activeFilters = 0;
        Object.entries(filters).forEach(([key, value]) => {
            if(value && value !== 'All' && value !== 'All Dates') {
                filterText += `${key.replace(/([A-Z])/g, ' $1').trim()}: ${value}\n`;
                activeFilters++;
            }
        });
        if(activeFilters === 0) filterText += "None\n";

        doc.setFontSize(11);
        doc.text(filterText, 14, 32);

        doc.autoTable({
            startY: 50, head: head, body: body, theme: 'striped',
            headStyles: { fillColor: [10, 10, 42] }
        });
        
        doc.save('DataCompass_Favorites.pdf');
    };

    const renderDashboard = (data = allData) => {
        const completed = data.filter(item => item.Outcome && item.Outcome !== "N/A");
        if (completed.length === 0) {
            ["stat-win-rate", "stat-accuracy"].forEach(id => document.getElementById(id).textContent = `0%`);
            document.getElementById("stat-total-tips").textContent = 0;
            if (outcomeChart) outcomeChart.destroy(); if (predictionChart) predictionChart.destroy();
            return;
        }
        const wins = completed.filter(item => getOutcomeColor(item.Prediction, item.Outcome)[2]).length;
        document.getElementById("stat-win-rate").textContent = `${(wins / completed.length * 100).toFixed(1)}%`;
        document.getElementById("stat-accuracy").textContent = `${(wins / completed.length * 100).toFixed(1)}%`;
        document.getElementById("stat-total-tips").textContent = completed.length;
        const outcomeCounts = completed.reduce((acc, item) => { acc[item.Outcome] = (acc[item.Outcome] || 0) + 1; return acc; }, {});
        if (outcomeChart) outcomeChart.destroy();
        if(document.getElementById("outcome-pie-chart")) {
            outcomeChart = new Chart(document.getElementById("outcome-pie-chart").getContext("2d"), { type: 'pie', data: { labels: Object.keys(outcomeCounts), datasets: [{ data: Object.values(outcomeCounts), backgroundColor: ["#10b981", "#ef4444", "#f59e0b"] }] } });
        }
        const predictionCounts = completed.reduce((acc, item) => { acc[item.Prediction] = (acc[item.Prediction] || 0) + 1; return acc; }, {});
        if (predictionChart) predictionChart.destroy();
        if(document.getElementById("prediction-bar-chart")) {
            predictionChart = new Chart(document.getElementById("prediction-bar-chart").getContext("2d"), { type: 'bar', data: { labels: Object.keys(predictionCounts), datasets: [{ label: 'Prediction Frequency', data: Object.values(predictionCounts), backgroundColor: '#0a0a2a' }] } });
        }
    };
    
    const renderScroller = () => {
        const scroller = document.querySelector("#upcoming-matches-scroller .scroller-inner");
        const upcoming = allData.filter(d => !d.Outcome || d.Outcome === "N/A").slice(0, 20);
        scroller.innerHTML = upcoming.map(match => `<div class="flex-shrink-0 w-64 p-3 m-2 bg-white/10 text-white rounded-lg text-xs font-semibold"><p>${match.Match}</p><p class="text-accent-green">${match.Prediction}</p></div>`).join('');
        scroller.innerHTML += scroller.innerHTML;
    }

    const populateFilters = () => {
        const uniqueDates = ['All Dates', ...[...new Set(allData.map(item => item['Match Date']).filter(Boolean))].sort((a, b) => new Date(b) - new Date(a))];
        document.getElementById('filter-date').innerHTML = uniqueDates.map(d => `<option value="${d}">${d}</option>`).join('');
        const uniqueLeagues = ['All', ...new Set(allData.map(item => item.League).filter(Boolean))].sort();
        document.getElementById('filter-league').innerHTML = uniqueLeagues.map(l => `<option value="${l}">${l}</option>`).join('');
        const uniquePredictions = ['All', ...new Set(allData.map(item => item.Prediction).filter(Boolean))].sort();
        document.getElementById('filter-prediction').innerHTML = uniquePredictions.map(p => `<option value="${p}">${p}</option>`).join('');
    }

    const clearFilters = () => {
        filters = { ...initialFilters };
        document.getElementById('team-search-input').value = '';
        document.getElementById('filter-date').value = 'All Dates';
        document.getElementById('filter-league').value = 'All';
        document.getElementById('filter-prediction').value = 'All';
        document.getElementById('filter-home-odds').value = '';
        applyFilters();
    };

    document.addEventListener('DOMContentLoaded', async () => {
        dom.loading.classList.remove('hidden');
        try {
            const response = await fetch(CSV_URL);
            if (!response.ok) throw new Error(`Network response error: ${response.statusText}`);
            const csvText = await response.text();
            allData = parseCSV(csvText);
            const savedFavorites = localStorage.getItem('favorites');
            if (savedFavorites) favorites = JSON.parse(savedFavorites);

            populateFilters();
            renderScroller();
            handleTabClick('dashboard');
        } catch (error) {
            console.error("Initialization failed:", error);
            dom.messageBox.classList.remove("hidden");
            dom.messageBox.querySelector("p").textContent = "Failed to load data. See console for details.";
        } finally {
            dom.loading.classList.add('hidden');
        }
    });
    </script>
</body>
</html>


